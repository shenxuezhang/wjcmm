<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excel/CSV åˆ—æ•°æ®å»é‡æå–å·¥å…· (ä¸“ä¸šç‰ˆ)</title>
    <!-- å¼•å…¥ SheetJS æ ¸å¿ƒåº“ï¼Œç”¨äºå¤„ç† Excel æ–‡ä»¶ -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #2563eb;
            --primary-hover: #1d4ed8;
            --bg: #f8fafc;
            --surface: #ffffff;
            --text: #334155;
            --border: #e2e8f0;
            --warning-bg: #fffbeb;
            --warning-text: #92400e;
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            /* ç§»é™¤ min-height å’Œå±…ä¸­ï¼Œè®©å†…å®¹è‡ªç„¶æµåŠ¨ */
            min-height: 100vh;
        }

        .container {
            /* 1. å¸ƒå±€è°ƒæ•´ï¼šå…è®¸å®¹å™¨å æ®æ›´å¤§ç©ºé—´ï¼Œå¹¶éšçª—å£å˜åŒ– */
            width: 95%; /* å æ®å¤§éƒ¨åˆ†å®½åº¦ */
            max-width: 1400px; /* è®¾ç½®ä¸€ä¸ªè¾ƒå¤§çš„æœ€å¤§å®½åº¦ */
            min-width: 600px; /* ä¿è¯æœ€å°å¯è¯»æ€§ */
            background: var(--surface);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            margin: 0 auto; /* å±…ä¸­æ˜¾ç¤º */
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #1e293b;
            font-size: 24px;
        }

        /* æ­¥éª¤å¡ç‰‡æ ·å¼ */
        .step-card {
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: #fff;
        }

        .step-header {
            font-weight: bold;
            font-size: 16px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            color: var(--primary);
        }

        .step-num {
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 10px;
            font-size: 14px;
        }

        /* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            cursor: pointer;
            background: #fdfdfd;
            transition: border-color 0.3s;
            position: relative;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #eff6ff;
        }

        .upload-area input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            opacity: 0;
            cursor: pointer;
        }

        /* è¡¨å•æ§ä»¶æ ·å¼ */
        select, button, input[type="text"] {
            padding: 10px 16px;
            border-radius: 6px;
            font-size: 14px;
            border: 1px solid var(--border);
            outline: none;
        }

        select {
            width: 100%;
            /* max-width: 400px; ä¿æŒé€‰æ‹©æ¡†å®½åº¦é€‚ä¸­ */
            background-color: white;
            margin-bottom: 10px;
            cursor: pointer;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            font-weight: 500;
            transition: background 0.2s;
            cursor: pointer;
            white-space: nowrap;
        }

        button:hover { background-color: var(--primary-hover); }
        button.btn-secondary { background-color: #64748b; }
        button.btn-secondary:hover { background-color: #475569; }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .btn-copy { background-color: #475569; }
        .btn-copy:hover { background-color: #334155; }

        .btn-export-col { background-color: #0d9488; }
        .btn-export-col:hover { background-color: #0f766e; }

        .btn-export-row { background-color: #16a34a; }
        .btn-export-row:hover { background-color: #15803d; }


        /* ç»“æœé¢„è§ˆåŒº */
        .result-container {
            display: none;
        }
        
        /* æ›´æ”¹ result-info çš„å¸ƒå±€å’Œæ ·å¼ */
        .result-info {
            font-size: 13px;
            margin-bottom: 15px;
            display: flex;
            gap: 15px; /* å¢åŠ é—´è· */
            flex-wrap: wrap;
        }
        
        /* æ–°å¢æ ·å¼ï¼šç»Ÿè®¡æŒ‡æ ‡çš„å¡ç‰‡ */
        .metric-box {
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 13px;
            min-width: 150px;
            text-align: center;
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }

        .metric-box strong {
            display: block;
            font-size: 20px;
            margin-top: 5px;
            line-height: 1;
        }

        .metric-original {
            background-color: #f0f9ff;
            color: #0369a1;
        }

        .metric-unique {
            background-color: #ecfdf5;
            color: #059669;
            border: 1px solid #a7f3d0;
        }

        .metric-removed {
            background-color: #fef2f2;
            color: #ef4444;
            border: 1px solid #fecaca;
        }

        /* æ–°å¢ï¼šåˆ—åæ ‡å¤´æ ·å¼ */
        #resultHeaderDisplay {
            padding: 8px 15px;
            background-color: #334155; /* æ·±ç°è‰²èƒŒæ™¯ */
            color: white; /* ç™½è‰²å­—ä½“ */
            font-family: 'Consolas', 'Courier New', monospace;
            font-size: 14px; /* ç•¥å¤§ä¸€ç‚¹ */
            font-weight: bold;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            border: 1px solid #1e293b;
            border-bottom: none; /* ä¸ä¸‹é¢çš„æ–‡æœ¬æ¡†èåˆ */
            box-sizing: border-box;
            width: 100%;
            display: none; /* åˆå§‹éšè— */
        }
        
        textarea {
            width: 100%;
            height: 200px;
            padding: 15px; /* å¢åŠ å†…è¾¹è· */
            border: 2px solid #bae6fd; /* æ›´æ˜æ˜¾çš„è¾¹æ¡† */
            border-radius: 8px; /* æ›´åœ†æ¶¦ */
            border-top-left-radius: 0; /* é¡¶éƒ¨åœ†è§’ç§»é™¤ï¼Œä¸ Header èåˆ */
            border-top-right-radius: 0;
            background-color: #fff; /* æ›´æ”¹èƒŒæ™¯ä¸ºç™½è‰² */
            font-family: 'Consolas', 'Courier New', monospace; /* æ›´æ”¹ç­‰å®½å­—ä½“ */
            font-size: 13px;
            resize: vertical;
            box-sizing: border-box;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.05); /* å‡¹é™·æ•ˆæœ */
        }
        
        /* å½“ header æ˜¾ç¤ºæ—¶ï¼Œè°ƒæ•´ textarea è¾¹æ¡† */
        .result-container.has-header textarea {
            border-top: 1px solid #bae6fd; /* é‡æ–°æ·»åŠ é¡¶éƒ¨è¾¹æ¡† */
            border-top-left-radius: 8px; /* æ¢å¤é¡¶éƒ¨åœ†è§’ */
            border-top-right-radius: 8px;
            margin-top: -1px; /* æ¶ˆé™¤ Header å’Œ Textarea ä¹‹é—´çš„é—´éš™ */
        }
        /* å½“ header æ˜¾ç¤ºæ—¶ï¼Œä¿®æ­£ textarea æ ·å¼ */
        .result-container.has-header textarea {
             border-top-left-radius: 0;
             border-top-right-radius: 0;
             border-top: none; /* ç§»é™¤é¡¶éƒ¨è¾¹æ¡†ï¼Œè®© Header æ‰¿æ‹… */
        }


        /* éªŒè¯é¢æ¿æ ·å¼ - å‡çº§ */
        .verify-panel {
            margin-top: 20px;
            padding: 20px;
            background-color: #f7f9fc; /* æµ…èƒŒæ™¯ */
            border: 1px solid #dbeafe;
            border-radius: 8px;
            color: var(--text);
        }

        /* é…ç½®åŒºæ ·å¼ */
        .config-panel {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid #bae6fd;
            border-radius: 8px;
            background-color: #f0f9ff;
        }
        .config-panel label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            font-weight: 500;
            color: #0369a1;
        }
        .config-panel input[type="checkbox"] {
            margin-right: 8px;
        }

        /* Loading Spinner */
        #loadingSpinner {
            display: none;
            text-align: center;
            padding: 20px;
            font-size: 16px;
            color: var(--primary);
        }

        .verify-title {
            font-weight: bold;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 18px;
            color: #1e293b;
        }

        .verify-grid {
            /* 2. å¸ƒå±€è°ƒæ•´ï¼šGrid å®¹å™¨éšå®½åº¦è‡ªé€‚åº” */
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* å¢åŠ æœ€å°å®½åº¦ï¼Œé€‚åº”æ›´å¤§çš„å®¹å™¨ */
            gap: 20px;
        }

        .verify-box {
            background: #fff;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e0e7ff;
        }
        
        /* ç‹¬ç«‹æ ·å¼ç”¨äºåŒºåˆ†æ•°æ®è´¨é‡ */
        .quality-metrics {
            color: #1e40af; /* æ·±è“è‰² */
            border-left: 4px solid #3b82f6;
        }
        
        .quality-metrics ul li {
            list-style: none;
            padding: 5px 0;
            font-size: 14px;
            border-bottom: 1px dashed #eff6ff;
        }
        
        .quality-metrics ul li strong {
            font-weight: bold;
            color: #ef4444; /* çº¢è‰²çªå‡ºç©ºå€¼ */
        }
        .quality-metrics ul li .success-count {
             color: #16a34a; /* ç»¿è‰²çªå‡ºå”¯ä¸€å€¼ */
        }


        .verify-input-group {
            display: flex;
            gap: 8px;
            margin-top: 5px;
        }
        
        .verify-input-group input {
            flex: 1;
        }

        .check-result {
            margin-top: 8px;
            font-size: 13px;
            font-weight: bold;
        }
        .check-result.success { color: #16a34a; }
        .check-result.error { color: #dc2626; }

        .top-dups {
            font-size: 12px;
            margin-top: 10px;
            max-height: 100px;
            overflow-y: auto;
            padding-left: 0;
        }
        .top-dups li { margin-bottom: 4px; list-style: circle inside; }

        .hidden { display: none; }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* æ–°å¢ï¼š Flexbox å®¹å™¨ç”¨äºå¹¶æ’å¸ƒå±€ */
        .flex-row-controls {
            display: flex;
            gap: 20px;
            margin-bottom: 5px; /* è°ƒæ•´æ•´ä½“ä¸‹è¾¹è· */
            flex-wrap: wrap; /* ç¡®ä¿åœ¨å°å±å¹•ä¸Šèƒ½å¤Ÿæ¢è¡Œ */
        }
        
        .control-group {
            flex: 1; /* ç¡®ä¿ä¸¤ä¸ªæ§ä»¶ç»„å¹³å‡åˆ†é…ç©ºé—´ */
            min-width: 250px; /* ç¡®ä¿åœ¨å°å±å¹•ä¸Šä¸ä¼šè¿‡åº¦å‹ç¼© */
        }
        
        /* è°ƒæ•´ select æ ·å¼ä»¥é€‚åº” flex å¸ƒå±€ */
        .control-group select {
            margin-bottom: 0; /* åœ¨æ–°çš„ control-group ä¸­ç§»é™¤åº•éƒ¨å¤šä½™çš„ margin */
        }

    </style>
</head>
<body>

<div class="container">
    <h1>Excel/CSV åˆ—æ•°æ®å»é‡æå–å·¥å…· <span style="font-size:14px; background:#e0f2fe; color:#0369a1; padding:2px 8px; border-radius:4px; vertical-align:middle;">ä¸“ä¸šç‰ˆ</span></h1>

    <!-- æ­¥éª¤ 1ï¼šä¸Šä¼ æ–‡ä»¶ -->
    <div class="step-card">
        <div class="step-header"><span class="step-num">1</span>ä¸Šä¼  Excel æˆ– CSV æ–‡ä»¶</div>
        <div class="upload-area" id="dropZone">
            <p id="fileLabel" style="margin:0; color:#666;">ç‚¹å‡»æ­¤å¤„é€‰æ‹©æ–‡ä»¶ï¼Œæˆ–å°†æ–‡ä»¶æ‹–æ‹½è‡³æ­¤<br><small>(æ”¯æŒ .xls, .xlsx, .csv)</small></p>
            <input type="file" id="fileInput" accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel">
        </div>
    </div>
    
    <!-- æ•°æ®å¤„ç†ä¸­çš„æç¤º -->
    <div id="loadingSpinner">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-current" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" style="width: 1.5rem; height: 1.5rem; display: inline-block; animation: spin 1s linear infinite;">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        æ•°æ®å¤„ç†ä¸­ï¼Œè¯·ç¨å€™... (å¤§æ–‡ä»¶å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ)
    </div>

    <!-- æ­¥éª¤ 2ï¼šé€‰æ‹©æ“ä½œåˆ—ä¸é…ç½® -->
    <div class="step-card hidden" id="step2">
        <div class="step-header"><span class="step-num">2</span>é€‰æ‹©å·¥ä½œè¡¨ã€æ“ä½œåˆ—ä¸é…ç½®</div>

        <!-- å¸ƒå±€å®¹å™¨ï¼šç”¨äºå°†å·¥ä½œè¡¨é€‰æ‹©å’Œåˆ—é€‰æ‹©å¹¶æ’æ˜¾ç¤º -->
        <div class="flex-row-controls">
            <!-- å·¥ä½œè¡¨é€‰æ‹©ç»„ -->
            <div id="worksheetSelection" class="control-group">
                <p style="font-size: 13px; color: #666; margin-top:0;">è¯·é€‰æ‹©è¦æ“ä½œçš„**å·¥ä½œè¡¨**:</p>
                <select id="sheetSelect" onchange="loadWorksheetData()">
                    <option value="" disabled selected>-- è¯·é€‰æ‹©å·¥ä½œè¡¨ --</option>
                </select>
            </div>
            
            <!-- ç›®æ ‡æ“ä½œåˆ—é€‰æ‹©ç»„ -->
            <div class="control-group">
                <p style="font-size: 13px; color: #666; margin-top:0;">è¯·é€‰æ‹©ä½ çš„**ç›®æ ‡æ“ä½œåˆ—**:</p>
                <select id="columnSelect" disabled>
                    <option value="" disabled selected>-- è¯·å…ˆé€‰æ‹©å·¥ä½œè¡¨ --</option>
                </select>
            </div>
        </div>

        <!-- é…ç½®åŒº -->
        <div class="config-panel">
            <div style="font-weight: bold; margin-bottom: 10px; color: #0369a1;">âš™ï¸ åŠŸèƒ½æ¨¡å¼è®¾ç½®</div>
            
            <div style="display: flex; gap: 20px; margin-bottom: 15px; flex-wrap: wrap;">
                <label style="font-weight: normal; margin-bottom: 0;">
                    <input type="radio" name="operationMode" value="deduplication" id="modeDeduplication" checked onchange="toggleMode()">
                    æ•°æ®å»é‡ï¼šä¸»é”®å”¯ä¸€åŒ– (ä¿ç•™é¦–è¡Œè®°å½•)
                </label>
                <label style="font-weight: normal; margin-bottom: 0;">
                    <input type="radio" name="operationMode" value="matching" id="modeMatching" onchange="toggleMode()">
                    æ•°æ®ç­›é€‰ï¼šå¤–éƒ¨æ¸…å•åŒ¹é… (æ–°å¢åŠŸèƒ½)
                </label>
            </div>

            <!-- æ ‡å‡†å»é‡é…ç½® -->
            <div id="deduplicationConfig">
                <label>
                    <input type="checkbox" id="caseSensitiveCheckbox" checked>
                    å»é‡æ—¶åŒºåˆ†å¤§å°å†™ (ä¾‹å¦‚ 'SKU' å’Œ 'sku' ç®—ä½œä¸åŒé¡¹)
                </label>
                <p id="deduplicationHint" style="font-size: 12px; color: #64748b; margin-top: 5px;">* **æ“ä½œè¯´æ˜:** ä¿ç•™ç›®æ ‡åˆ—å€¼ç¬¬ä¸€æ¬¡å‡ºç°æ—¶**æ•´è¡Œæ•°æ®**ï¼Œå¹¶åˆ é™¤æ‰€æœ‰é‡å¤è¡Œã€‚</p>
            </div>
            
            <!-- åˆ—è¡¨åŒ¹é…é…ç½® (åˆå§‹éšè—) -->
            <div id="matchingConfig" style="display: none;">
                <p style="font-size: 13px; font-weight: 500; color: #1e293b;">è¯·ç²˜è´´ä½ æƒ³è¦åŒ¹é…çš„åˆ—è¡¨æ•°æ®ï¼ˆæ¯è¡Œä¸€ä¸ªå€¼ï¼‰ï¼š</p>
                <textarea id="matchListArea" placeholder="ç²˜è´´ SKUã€è®¢å•å·ã€å•†å“ç¼–ç ç­‰åˆ—è¡¨..." style="height: 100px; padding: 10px;"></textarea>
                <label style="margin-top: 10px;">
                    <input type="checkbox" id="matchCaseSensitiveCheckbox" checked>
                    åŒ¹é…æ—¶åŒºåˆ†å¤§å°å†™
                </label>
                <p id="matchingHint" style="font-size: 12px; color: #64748b; margin-top: 5px;">* **æ“ä½œè¯´æ˜:** å°†ç²˜è´´åˆ—è¡¨ä¸­çš„æ¯ä¸ªå€¼ä¸ç›®æ ‡æ“ä½œåˆ—è¿›è¡ŒåŒ¹é…ï¼Œå¹¶æå–æ‰€æœ‰åŒ¹é…åˆ°çš„**å®Œæ•´è¡Œæ•°æ®**ã€‚</p>
            </div>
        </div>

        <button onclick="handleProcess()" style="width: 100%; max-width: 200px; margin-top: 15px;">å¼€å§‹æ‰§è¡Œæ“ä½œ</button>
    </div>

    <!-- æ­¥éª¤ 3ï¼šç»“æœé¢„è§ˆä¸éªŒè¯ -->
    <!-- æ·»åŠ ç±»å has-header ç”¨äºåœ¨ JS ä¸­åˆ‡æ¢ textarea æ ·å¼ -->
    <div class="step-card result-container has-header" id="step3">
        <div class="step-header"><span class="step-num">3</span><span id="resultHeaderTitle">ç»“æœé¢„è§ˆä¸å¯¼å‡º</span></div>
        
        <!-- ä¼˜åŒ–åçš„ç»Ÿè®¡æŒ‡æ ‡å±•ç¤º -->
        <div class="result-info">
            <div id="statsOriginal" class="metric-box metric-original">åŸå§‹æ€»è¡Œæ•°(æ–‡ä»¶): <strong>0</strong></div>
            <div id="statsUnique" class="metric-box metric-unique">ä¿ç•™å»é‡è¡Œ: <strong>0</strong></div>
            <div id="statsRemoved" class="metric-box metric-removed">å·²ç§»é™¤é‡å¤è¡Œ: <strong>0</strong></div>
        </div>
        
        <!-- æ–°å¢ï¼šåˆ—åæ˜¾ç¤ºåŒºåŸŸ -->
        <div id="resultHeaderDisplay" style="display: none;"></div>

        <!-- é¢„è§ˆåŒºä»…æ˜¾ç¤ºå»é‡åçš„ç›®æ ‡åˆ—æ•°æ® -->
        <textarea id="resultArea" readonly placeholder="è¯·å…ˆæ‰§è¡Œæ“ä½œä»¥æŸ¥çœ‹å»é‡/åŒ¹é…åçš„ç›®æ ‡åˆ—æ•°æ®ã€‚"></textarea>
        
        <div class="btn-group">
            <button class="btn-copy" onclick="copyResult()">ä¸€é”®å¤åˆ¶é¢„è§ˆç»“æœ</button>
            <button class="btn-export-col" onclick="exportSingleColumn()">å¯¼å‡ºä¸º **å•åˆ— Excel**</button>
            <button class="btn-export-row" onclick="exportFullRows()">å¯¼å‡ºä¸º **å®Œæ•´è¡Œ Excel**</button>
        </div>

        <!-- éªŒè¯é¢æ¿ (å‡çº§åçš„åˆ†æä¸­å¿ƒ) -->
        <div class="verify-panel" id="verifyPanel">
            <div class="verify-title">ğŸ“ˆ æ•°æ®è´¨é‡ä¸å»é‡åˆ†æä¸­å¿ƒ</div>
            <div class="verify-grid">
                
                <!-- æ–°å¢ï¼šæ•°æ®è´¨é‡æŒ‡æ ‡ -->
                <div class="verify-box quality-metrics">
                    <h4 style="margin:0 0 10px 0; font-size:14px; color: #1e40af;">ğŸ› ï¸ æ•°æ®è´¨é‡æŒ‡æ ‡ (åŸºäºæ‰€é€‰åˆ—)</h4>
                    <ul class="top-dups">
                        <li>åŸå§‹æ€»è¡Œæ•° (æ–‡ä»¶): <strong><span id="metricTotalRows">0</span></strong></li>
                        <li>ç©ºå€¼/æ— æ•ˆè¡Œæ•°: <strong><span id="metricEmptyCount">0</span></strong></li>
                        <li>ç»å¯¹å”¯ä¸€å€¼æ•° (åªå‡ºç°ä¸€æ¬¡): <strong class="success-count"><span id="metricUniqueOnceCount">0</span></strong></li>
                        <li>å»é‡åå‰©ä½™è¡Œæ•°: <strong class="success-count"><span id="metricRetainedRows">0</span></strong></li>
                    </ul>
                </div>
                
                <!-- é‡å¤é¡¹æ€»è§ˆ -->
                <div class="verify-box">
                    <h4 style="margin:0 0 10px 0; font-size:14px;">ğŸ“Š é‡å¤é¡¹æ€»è§ˆï¼ˆTop 5ï¼‰</h4>
                    <p style="margin:0; font-size:13px; color:#666;">é‡å¤æ¬¡æ•°æœ€å¤šçš„å‰ 5 é¡¹ï¼š</p>
                    <ul class="top-dups" id="topDupsList">
                        <li>æš‚æ— æ•°æ®</li>
                    </ul>
                </div>
            </div>
            
            <!-- äººå·¥æŠ½æ£€ (æ”¾ç½®åœ¨åº•éƒ¨ï¼Œå æ®æ•´è¡Œ) -->
            <div class="verify-box" style="margin-top:20px; grid-column: 1 / -1;">
                <h4 style="margin:0 0 10px 0; font-size:14px;">ğŸ•µï¸â€â™‚ï¸ äººå·¥æŠ½æ£€ (Spot Check)</h4>
                <p style="margin:0; font-size:13px; color:#666;">è¾“å…¥ä»»æ„å€¼ï¼Œæ£€æŸ¥å…¶åœ¨åŸå§‹è¡¨å’Œå»é‡ç»“æœä¸­çš„çŠ¶æ€ï¼š</p>
                <div class="verify-input-group">
                    <input type="text" id="checkInput" placeholder="ä¾‹å¦‚ç²˜è´´ä¸€ä¸ª SKU...">
                    <button onclick="checkValue()" class="btn-secondary" style="padding: 5px 10px;">æŸ¥è¯¢</button>
                </div>
                <div id="checkResult" class="check-result"></div>
            </div>
        </div>
    </div>
</div>

<script>
    let globalWorkbook = null; // å­˜å‚¨æ•´ä¸ªå·¥ä½œç°¿å¯¹è±¡
    let globalData = []; // å­˜å‚¨å½“å‰é€‰å®šå·¥ä½œè¡¨çš„æ•°æ®
    let uniqueRows = []; // å­˜å‚¨å»é‡/åŒ¹é…åä¿ç•™çš„å®Œæ•´è¡Œæ•°æ®
    let currentFileName = "";
    let currentColumn = ""; // å­˜å‚¨å½“å‰é€‰æ‹©çš„å»é‡åˆ—å
    let currentSheetName = ""; // å­˜å‚¨å½“å‰é€‰å®šçš„å·¥ä½œè¡¨å
    let currentMode = "deduplication"; // è·Ÿè¸ªå½“å‰æ¨¡å¼
    
    // é¢‘ç‡æ˜ å°„è¡¨ï¼šKey=åŸå§‹å†…å®¹, Value=å‡ºç°æ¬¡æ•° (ç”¨äºç»Ÿè®¡å’ŒéªŒè¯ï¼Œå­˜å‚¨åŸå§‹å¤§å°å†™çš„å€¼)
    let frequencyMap = new Map();

    document.getElementById('fileInput').addEventListener('change', handleFile);
    
    // è¾…åŠ©å‡½æ•°ï¼šæ˜¾ç¤º/éšè—åŠ è½½æŒ‡ç¤ºå™¨
    function toggleLoading(show) {
        document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
        document.getElementById('step2').style.opacity = show ? '0.5' : '1';
        document.getElementById('step2').style.pointerEvents = show ? 'none' : 'auto';
    }
    
    // è¾…åŠ©å‡½æ•°ï¼šåˆ‡æ¢æ¨¡å¼çš„æ˜¾ç¤ºé…ç½®
    function toggleMode() {
        currentMode = document.querySelector('input[name="operationMode"]:checked').value;
        const dedupConfig = document.getElementById('deduplicationConfig');
        const matchConfig = document.getElementById('matchingConfig');

        if (currentMode === 'deduplication') {
            dedupConfig.style.display = 'block';
            matchConfig.style.display = 'none';
        } else {
            dedupConfig.style.display = 'none';
            matchConfig.style.display = 'block';
        }
    }

    // æ‹–æ‹½é€»è¾‘
    const dropZone = document.getElementById('dropZone');
    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.style.borderColor = '#2563eb'; });
    dropZone.addEventListener('dragleave', (e) => { e.preventDefault(); dropZone.style.borderColor = '#e2e8f0'; });
    dropZone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropZone.style.borderColor = '#e2e8f0';
        if(e.dataTransfer.files.length) {
            document.getElementById('fileInput').files = e.dataTransfer.files;
            handleFile({target: {files: e.dataTransfer.files}});
        }
    });

    /**
     * æ­¥éª¤ 1ï¼šå¤„ç†æ–‡ä»¶ä¸Šä¼ 
     */
    function handleFile(e) {
        toggleLoading(true);
        const file = e.target.files[0];
        if (!file) {
            toggleLoading(false);
            return;
        }

        currentFileName = file.name;
        document.getElementById('fileLabel').innerHTML = `âœ… å·²é€‰æ‹©æ–‡ä»¶ï¼š<strong>${file.name}</strong>`;

        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = new Uint8Array(e.target.result);
                // è¯»å–æ•´ä¸ªå·¥ä½œç°¿ï¼Œä¸ç«‹å³è½¬æ¢æˆ JSON
                globalWorkbook = XLSX.read(data, {type: 'array'});
                
                if (!globalWorkbook || globalWorkbook.SheetNames.length === 0) {
                    console.error("æ–‡ä»¶ä¸­æ²¡æœ‰è¯†åˆ«åˆ°ä»»ä½•å·¥ä½œè¡¨ã€‚");
                    return;
                }
                
                // åˆå§‹åŒ–å·¥ä½œè¡¨é€‰æ‹©
                initSheetSelect(globalWorkbook.SheetNames);
                document.getElementById('step2').classList.remove('hidden');
                document.getElementById('step3').style.display = 'none';

            } catch (error) {
                console.error("æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡® (Excel/CSV)ã€‚é”™è¯¯ä¿¡æ¯: " + error.message);
            } finally {
                toggleLoading(false);
            }
        };
        reader.readAsArrayBuffer(file);
    }
    
    /**
     * è¾…åŠ©å‡½æ•°ï¼šåˆå§‹åŒ–å·¥ä½œè¡¨é€‰æ‹©ä¸‹æ‹‰èœå•
     */
    function initSheetSelect(sheetNames) {
        const select = document.getElementById('sheetSelect');
        select.innerHTML = '<option value="" disabled selected>-- è¯·é€‰æ‹©å·¥ä½œè¡¨ --</option>';
        
        // ç¦ç”¨åˆ—é€‰æ‹©ï¼Œç›´åˆ°å·¥ä½œè¡¨è¢«é€‰ä¸­
        document.getElementById('columnSelect').disabled = true;
        document.getElementById('columnSelect').innerHTML = '<option value="" disabled selected>-- è¯·å…ˆé€‰æ‹©å·¥ä½œè¡¨ --</option>';

        sheetNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.text = name;
            select.appendChild(option);
        });
        // å¦‚æœåªæœ‰ä¸€ä¸ªå·¥ä½œè¡¨ï¼Œåˆ™è‡ªåŠ¨é€‰ä¸­å¹¶åŠ è½½æ•°æ®
        if (sheetNames.length === 1) {
            select.value = sheetNames[0];
            loadWorksheetData();
        }
    }

    /**
     * æ­¥éª¤ 2.1ï¼šæ ¹æ®é€‰å®šçš„å·¥ä½œè¡¨åŠ è½½æ•°æ®å¹¶åˆå§‹åŒ–åˆ—é€‰æ‹©
     */
    function loadWorksheetData() {
        toggleLoading(true);
        setTimeout(() => {
            const sheetName = document.getElementById('sheetSelect').value;
            if (!sheetName || !globalWorkbook) {
                toggleLoading(false);
                return;
            }
            
            currentSheetName = sheetName;
            const worksheet = globalWorkbook.Sheets[sheetName];
            
            // å°†é€‰å®šçš„å·¥ä½œè¡¨æ•°æ®è½¬æ¢ä¸º JSON
            globalData = XLSX.utils.sheet_to_json(worksheet, {defval: ""});

            if (globalData.length === 0) {
                console.warn(`å·¥ä½œè¡¨ [${sheetName}] ä¸­æ²¡æœ‰è¯†åˆ«åˆ°æ•°æ®ã€‚`);
            }
            
            // åˆå§‹åŒ–åˆ—é€‰æ‹©
            initColumnSelect();
            document.getElementById('columnSelect').disabled = false;
            document.getElementById('step3').style.display = 'none';
            toggleLoading(false);
        }, 10);
    }

    /**
     * è¾…åŠ©å‡½æ•°ï¼šåˆå§‹åŒ–åˆ—é€‰æ‹©ä¸‹æ‹‰èœå•
     */
    function initColumnSelect() {
        const select = document.getElementById('columnSelect');
        select.innerHTML = '<option value="" disabled selected>-- è¯·é€‰æ‹©åˆ—å --</option>';
        
        if (globalData.length > 0) {
            const headers = Object.keys(globalData[0]);
            headers.forEach(header => {
                if (header && !header.startsWith("__EMPTY")) {
                    const option = document.createElement('option');
                    option.value = header;
                    option.text = header;
                    select.appendChild(option);
                }
            });
        }
    }
    
    // --- æ ¸å¿ƒè°ƒåº¦å‡½æ•° ---
    function handleProcess() {
        const column = document.getElementById('columnSelect').value;
        if (!column) {
            console.warn("è¯·å…ˆé€‰æ‹©ä¸€ä¸ªåˆ—ï¼");
            return;
        }
        
        currentColumn = column;
        
        if (currentMode === 'deduplication') {
            processDeduplicationData();
        } else if (currentMode === 'matching') {
            processMatchData();
        }
    }

    // --- æ¨¡å¼ 1: æ ‡å‡†å»é‡é€»è¾‘ ---
    function processDeduplicationData() {
        toggleLoading(true);
        setTimeout(() => {
            const isCaseSensitive = document.getElementById('caseSensitiveCheckbox').checked;
            const column = currentColumn;

            // é‡ç½®æ•°æ®
            frequencyMap.clear();
            uniqueRows = [];
            let uniqueValueKeys = new Set();
            let rawCount = 0; // éç©ºè¡Œè®¡æ•°
            let emptyCount = 0; // ç©ºè¡Œè®¡æ•°

            // éå†æ‰€æœ‰è¡Œè¿›è¡Œå»é‡å’Œé¢‘ç‡ç»Ÿè®¡
            globalData.forEach(row => {
                let val = row[column];
                
                // 1. æ¸…æ´—å€¼å¹¶ç»Ÿè®¡ç©ºè¡Œ
                if (val === undefined || val === null || String(val).trim() === '') {
                    emptyCount++;
                    return; 
                }
                
                const originalVal = String(val).trim();
                const key = isCaseSensitive ? originalVal : originalVal.toLowerCase();
                rawCount++; // ç»Ÿè®¡éç©ºè¡Œæ•°

                // 2. ç»Ÿè®¡é¢‘ç‡ (åŸºäº originalVal)
                frequencyMap.set(originalVal, (frequencyMap.get(originalVal) || 0) + 1);

                // 3. å»é‡é€»è¾‘ (åŸºäº key)
                if (!uniqueValueKeys.has(key)) {
                    uniqueValueKeys.add(key);
                    uniqueRows.push(row); // ä¿ç•™å®Œæ•´è¡Œ
                }
            });
            
            const uniqueCount = uniqueRows.length;
            const removedCount = rawCount - uniqueCount;

            // 4. è®¡ç®— True Unique Count (åªå‡ºç°ä¸€æ¬¡çš„å€¼)
            let uniqueOnceCount = 0;
            frequencyMap.forEach(count => {
                if (count === 1) {
                    uniqueOnceCount++;
                }
            });

            // 5. æ›´æ–°ç»Ÿè®¡
            updateStats('æ•°æ®å»é‡ç»“æœ');
            document.getElementById('statsUnique').innerHTML = `ä¿ç•™å»é‡è¡Œ: <strong>${uniqueCount}</strong>`;
            document.getElementById('statsRemoved').innerHTML = `å·²ç§»é™¤é‡å¤è¡Œ: <strong>${removedCount}</strong>`;
            
            // 6. ç»“æœé¢„è§ˆåŒºæ·»åŠ è¡¨å¤´ï¼ˆåˆ—åï¼‰å’Œæ•°æ®
            const previewData = uniqueRows.map(row => row[column]);
            
            // ä¼˜åŒ–ï¼šå°†åˆ—åæ”¾å…¥å•ç‹¬çš„ Header div
            document.getElementById('resultHeaderDisplay').innerText = column;
            document.getElementById('resultHeaderDisplay').style.display = 'block';

            // textarea åªåŒ…å«æ•°æ®éƒ¨åˆ†
            document.getElementById('resultArea').value = previewData.join('\n');
            
            // 7. ç”ŸæˆéªŒè¯åˆ†ææ•°æ®
            generateVerificationReport(emptyCount, uniqueOnceCount);
            document.getElementById('verifyPanel').classList.remove('hidden'); // æ˜¾ç¤ºéªŒè¯é¢æ¿

            document.getElementById('step3').style.display = 'block';
            toggleLoading(false);
        }, 10);
    }
    
    // --- æ¨¡å¼ 2: åˆ—è¡¨åŒ¹é…é€»è¾‘ (æ–°å¢åŠŸèƒ½) ---
    function processMatchData() {
        toggleLoading(true);
        setTimeout(() => {
            const matchListText = document.getElementById('matchListArea').value;
            const isCaseSensitive = document.getElementById('matchCaseSensitiveCheckbox').checked;
            const column = currentColumn;

            // 1. è§£æç²˜è´´çš„åˆ—è¡¨
            const inputList = matchListText.split('\n')
                .map(line => String(line).trim())
                .filter(line => line.length > 0);
                
            // å°†åŒ¹é…åˆ—è¡¨è½¬æ¢ä¸º Setï¼Œæé«˜æŸ¥è¯¢æ•ˆç‡
            const matchSet = new Set(inputList.map(val => isCaseSensitive ? val : val.toLowerCase()));

            uniqueRows = []; // å­˜å‚¨åŒ¹é…åˆ°çš„è¡Œ
            let matchedCount = 0;

            // 2. éå†åŸå§‹æ•°æ®è¿›è¡ŒåŒ¹é…
            globalData.forEach(row => {
                let val = row[column];
                
                if (val === undefined || val === null || String(val).trim() === '') {
                    // å¿½ç•¥ç©ºå€¼è¡Œ
                    return; 
                }
                
                const originalVal = String(val).trim();
                const key = isCaseSensitive ? originalVal : originalVal.toLowerCase();

                // 3. åŒ¹é…é€»è¾‘
                if (matchSet.has(key)) {
                    uniqueRows.push(row); // åŒ¹é…æˆåŠŸï¼Œä¿ç•™å®Œæ•´è¡Œ
                    matchedCount++;
                }
            });
            
            // 4. æ›´æ–°ç»Ÿè®¡
            updateStats('å¤–éƒ¨æ¸…å•åŒ¹é…ç»“æœ');
            document.getElementById('statsUnique').innerHTML = `åŒ¹é…åˆ°çš„è¡Œæ•°: <strong>${matchedCount}</strong>`;
            document.getElementById('statsRemoved').innerHTML = `æœªåŒ¹é…åˆ°çš„è¡Œæ•°: <strong>${globalData.length - matchedCount}</strong>`;
            
            // 5. ç»“æœé¢„è§ˆåŒºæ·»åŠ è¡¨å¤´ï¼ˆåˆ—åï¼‰å’Œæ•°æ®
            const previewData = uniqueRows.map(row => row[column]);
            
            // ä¼˜åŒ–ï¼šå°†åˆ—åæ”¾å…¥å•ç‹¬çš„ Header div
            document.getElementById('resultHeaderDisplay').innerText = column;
            document.getElementById('resultHeaderDisplay').style.display = 'block';

            // textarea åªåŒ…å«æ•°æ®éƒ¨åˆ†
            document.getElementById('resultArea').value = previewData.join('\n');
            
            // 6. åŒ¹é…æ¨¡å¼ä¸‹ï¼Œåˆ†æé¢æ¿ä¸é€‚ç”¨ï¼Œéšè—å®ƒ
            document.getElementById('verifyPanel').classList.add('hidden');

            document.getElementById('step3').style.display = 'block';
            toggleLoading(false);
        }, 10);
    }

    // æ›´æ–°ç»Ÿè®¡æŒ‡æ ‡çš„é€šç”¨å‡½æ•°
    function updateStats(title) {
        document.getElementById('resultHeaderTitle').innerText = title;
        document.getElementById('statsOriginal').innerHTML = `åŸå§‹æ€»è¡Œæ•°(æ–‡ä»¶): <strong>${globalData.length}</strong>`;
    }

    // ç”ŸæˆéªŒè¯æŠ¥å‘Šï¼ˆæ•´åˆäº†æ•°æ®è´¨é‡å’Œ Top 5 é‡å¤é¡¹ï¼‰
    function generateVerificationReport(emptyCount, uniqueOnceCount) {
        // --- 1. æ•°æ®è´¨é‡æŒ‡æ ‡æ›´æ–° ---
        document.getElementById('metricTotalRows').innerText = globalData.length;
        document.getElementById('metricEmptyCount').innerText = emptyCount;
        document.getElementById('metricUniqueOnceCount').innerText = uniqueOnceCount;
        document.getElementById('metricRetainedRows').innerText = uniqueRows.length;


        // --- 2. é‡å¤é¡¹æ€»è§ˆæ›´æ–° ---
        const listEl = document.getElementById('topDupsList');
        listEl.innerHTML = '';

        // å°† Map è½¬ä¸ºæ•°ç»„å¹¶æŒ‰é¢‘ç‡é™åºæ’åº
        const sortedEntries = [...frequencyMap.entries()].sort((a, b) => b[1] - a[1]);
        
        // å–å‰5ä¸ªä¸”æ¬¡æ•°>1çš„é¡¹
        const topDuplicates = sortedEntries.filter(entry => entry[1] > 1).slice(0, 5);

        if (topDuplicates.length === 0) {
            listEl.innerHTML = '<li style="list-style: none;">ğŸ‰ å¤ªæ£’äº†ï¼ŒåŸå§‹æ•°æ®ä¸­æ²¡æœ‰å‘ç°ä»»ä½•é‡å¤é¡¹ï¼</li>';
        } else {
            topDuplicates.forEach(entry => {
                const [key, count] = entry;
                const li = document.createElement('li');
                li.innerHTML = `<strong>${key}</strong>: åŸå§‹å‡ºç° ${count} æ¬¡ <span style="color:#16a34a">â†’ ç»“æœä¿ç•™ 1 è¡Œ</span>`;
                listEl.appendChild(li);
            });
            if (sortedEntries.filter(entry => entry[1] > 1).length > 5) {
                const moreLi = document.createElement('li');
                moreLi.innerText = '...ä»¥åŠæ›´å¤š';
                moreLi.style.color = '#666';
                moreLi.style.fontStyle = 'italic';
                listEl.appendChild(moreLi);
            }
        }
        
        // é‡ç½®æŸ¥è¯¢ç»“æœ
        document.getElementById('checkResult').innerText = '';
        document.getElementById('checkInput').value = '';
    }

    // äººå·¥æŠ½æ£€åŠŸèƒ½ (åªåœ¨å»é‡æ¨¡å¼ä¸‹å¯ç”¨)
    function checkValue() {
        if (currentMode !== 'deduplication') {
            document.getElementById('checkResult').innerHTML = '<span style="color:red">è¯¥åŠŸèƒ½ä»…åœ¨â€œæ•°æ®å»é‡ï¼šä¸»é”®å”¯ä¸€åŒ–â€æ¨¡å¼ä¸‹å¯ç”¨ã€‚</span>';
            return;
        }

        const val = document.getElementById('checkInput').value.trim();
        const resDiv = document.getElementById('checkResult');
        const isCaseSensitive = document.getElementById('caseSensitiveCheckbox').checked;
        
        if (!val) {
            resDiv.innerText = "è¯·è¾“å…¥å†…å®¹";
            resDiv.className = "check-result error";
            return;
        }

        // æŸ¥æ‰¾åŸå§‹å‡ºç°æ¬¡æ•° (åŸºäºåŸå§‹å€¼å®Œå…¨åŒ¹é…)
        const countInOriginal = frequencyMap.get(val) || 0; 
        
        // éªŒè¯å»é‡ç»“æœ
        let countInResult = 0;
        // keyç”¨äºå»é‡åˆ¤æ–­
        const key = isCaseSensitive ? val : val.toLowerCase();
        
        // éå† uniqueRows éªŒè¯è¯¥å€¼æ˜¯å¦å­˜åœ¨
        const column = currentColumn;
        uniqueRows.forEach(row => {
            let rowVal = String(row[column]).trim();
            // rowKey ç”¨äºåŒ¹é… uniqueValueKeys çš„é€»è¾‘
            let rowKey = isCaseSensitive ? rowVal : rowVal.toLowerCase();
            
            if (rowKey === key) {
                countInResult++;
            }
        });

        if (countInOriginal === 0) {
            resDiv.innerHTML = `âŒ åŸå§‹è¡¨æ ¼ä¸­**ä¸å­˜åœ¨**è¯¥å€¼`;
            resDiv.className = "check-result error";
        } else {
            // ç¡®ä¿å»é‡ååªä¿ç•™äº†ä¸€è¡Œ
            const statusText = countInResult === 1 ? 
                '<span style="color:#16a34a">âœ… å»é‡å‡†ç¡® (ä¿ç•™ 1 è¡Œ)</span>' : 
                '<span style="color:red">âŒ éªŒè¯å¤±è´¥ (ä¿ç•™äº†å¤šè¡Œæˆ– 0 è¡Œ)</span>';
            
            resDiv.innerHTML = `
                åŸå§‹å‡ºç°: <strong>${countInOriginal}</strong> æ¬¡<br>
                å»é‡åä¿ç•™è¡Œæ•°: <strong>${countInResult}</strong> è¡Œ<br>
                ${statusText}
            `;
            resDiv.className = "check-result " + (countInResult === 1 ? "success" : "error");
        }
    }

    function copyResult() {
        const textarea = document.getElementById('resultArea');
        const header = document.getElementById('resultHeaderDisplay').innerText;
        
        // å¤åˆ¶æ—¶é‡æ–°ç»„åˆï¼šæ ‡å¤´ + æ¢è¡Œ + æ•°æ®
        const textToCopy = header + '\n' + textarea.value;

        // ä¸´æ—¶åˆ›å»ºä¸€ä¸ª textarea æ¥æ‰§è¡Œå¤åˆ¶
        const tempTextArea = document.createElement('textarea');
        tempTextArea.value = textToCopy;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();

        try {
            document.execCommand('copy'); 
            const btn = document.querySelector('.btn-copy');
            const originalText = btn.innerText;
            btn.innerText = "âœ… å·²å¤åˆ¶ï¼";
            setTimeout(() => btn.innerText = originalText, 2000);
        } catch (err) {
            console.error('å¤åˆ¶å¤±è´¥', err);
            const btn = document.querySelector('.btn-copy');
            const originalText = btn.innerText;
            btn.innerText = "âš ï¸ å¤åˆ¶å¤±è´¥ï¼";
            setTimeout(() => btn.innerText = originalText, 2000);
        } finally {
            document.body.removeChild(tempTextArea);
        }
    }

    /**
     * å¯¼å‡ºä¸ºå•åˆ— Excel æ–‡ä»¶
     */
    function exportSingleColumn() {
        if (uniqueRows.length === 0) {
            console.warn("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");
            return;
        }
        const columnName = currentColumn; // ä½¿ç”¨å­˜å‚¨çš„åˆ—å
        const modeLabel = currentMode === 'deduplication' ? 'å»é‡' : 'åŒ¹é…';
        
        // 1. æå–å•åˆ—æ•°æ®
        const exportData = uniqueRows.map(row => {
            let obj = {};
            obj[columnName] = row[columnName]; // åªä¿ç•™ç›®æ ‡åˆ—
            return obj;
        });

        // 2. åˆ›å»ºå·¥ä½œç°¿
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(exportData);
        
        // è®¾ç½®åˆ—å®½
        ws['!cols'] = [{wch: Math.max(columnName.length * 1.5, 30)}];

        XLSX.utils.book_append_sheet(wb, ws, `${modeLabel}åå•åˆ—`);
        
        const safeName = currentFileName.replace(/\.[^/.]+$/, "");
        XLSX.writeFile(wb, `${safeName}_${currentSheetName}_${columnName}_${modeLabel}å•åˆ—.xlsx`);
    }

    /**
     * å¯¼å‡ºä¸ºå®Œæ•´è¡Œ Excel æ–‡ä»¶
     */
    function exportFullRows() {
        if (uniqueRows.length === 0) {
            console.warn("æ²¡æœ‰æ•°æ®å¯å¯¼å‡º");
            return;
        }
        
        const wb = XLSX.utils.book_new();
        // å°† JSON å¯¹è±¡æ•°ç»„è½¬æ¢ä¸º Sheetï¼ŒåŒ…å«æ‰€æœ‰åˆ—
        const ws = XLSX.utils.json_to_sheet(uniqueRows);
        
        // å°è¯•è®¾ç½®åˆ—å®½ä»¥æ”¹å–„æ˜¾ç¤ºæ•ˆæœ
        if (uniqueRows.length > 0) {
            const headers = Object.keys(uniqueRows[0]);
            const columnWidths = headers.map(h => ({ wch: Math.max(h.length + 5, 20) }));
            ws['!cols'] = columnWidths;
        }

        const modeLabel = currentMode === 'deduplication' ? 'å»é‡' : 'åŒ¹é…';
        XLSX.utils.book_append_sheet(wb, ws, `${modeLabel}åå®Œæ•´è¡Œ`);
        
        const columnName = currentColumn; // ä½¿ç”¨å­˜å‚¨çš„åˆ—å
        const safeName = currentFileName.replace(/\.[^/.]+$/, "");
        XLSX.writeFile(wb, `${safeName}_${currentSheetName}_${columnName}_${modeLabel}å®Œæ•´è¡Œ.xlsx`);
    }
</script>

</body>
</html>