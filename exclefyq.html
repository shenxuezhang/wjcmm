<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Excel è¡¨æ ¼å†…å®¹ç¿»è¯‘å·¥å…· | Qwen-Max</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
    :root {
        /* Apple System Colors */
        --ios-blue: #007AFF;
        --ios-blue-hover: #0062cc;
        --ios-green: #34C759;
        --ios-green-hover: #248a3d;
        --ios-orange: #FF9500;
        
        /* Light Mode Variables */
        --bg-color: #F5F5F7;
        --card-bg: rgba(255, 255, 255, 0.72);
        --card-border: rgba(255, 255, 255, 0.5);
        --text-primary: #1D1D1F;
        --text-secondary: #86868B;
        --border-color: #D2D2D7;
        --input-bg: rgba(255, 255, 255, 0.8);
        --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.08);
        --glass-filter: saturate(180%) blur(20px);
        --table-header: #F5F5F7;
        --table-hover: #F2F2F7;
        
        /* Tooltip Colors */
        --tooltip-bg: rgba(0, 0, 0, 0.8);
        --tooltip-text: #fff;
    }

    [data-theme="dark"] {
        /* Dark Mode Variables */
        --bg-color: #000000;
        --card-bg: rgba(28, 28, 30, 0.72);
        --card-border: rgba(255, 255, 255, 0.1);
        --text-primary: #F5F5F7;
        --text-secondary: #86868B;
        --border-color: #38383A;
        --input-bg: rgba(44, 44, 46, 0.8);
        --shadow-lg: 0 20px 40px rgba(0, 0, 0, 0.4);
        --table-header: #1C1C1E;
        --table-hover: #2C2C2E;
        
        /* Tooltip Colors Dark */
        --tooltip-bg: rgba(255, 255, 255, 0.9);
        --tooltip-text: #000;
    }

    body {
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", sans-serif;
        background-color: var(--bg-color);
        background-image: 
            radial-gradient(at 0% 0%, rgba(0, 122, 255, 0.15) 0px, transparent 50%),
            radial-gradient(at 100% 0%, rgba(255, 59, 48, 0.1) 0px, transparent 50%),
            radial-gradient(at 100% 100%, rgba(52, 199, 89, 0.15) 0px, transparent 50%);
        background-attachment: fixed;
        background-size: cover;
        min-height: 100vh;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        transition: background 0.4s ease;
    }

    .container {
        width: 100%;
        max-width: 980px;
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 20px;
        backdrop-filter: var(--glass-filter);
        -webkit-backdrop-filter: var(--glass-filter);
        box-shadow: var(--shadow-lg);
        padding: 40px;
        position: relative;
        animation: scaleIn 0.6s cubic-bezier(0.16, 1, 0.3, 1);
    }

    @keyframes scaleIn { from { opacity: 0; transform: scale(0.96); } to { opacity: 1; transform: scale(1); } }

    /* =========================================
       æ–°ç‰ˆä¸»é¢˜åˆ‡æ¢æŒ‰é’®æ ·å¼ (Start)
       ========================================= */
    .theme-toggle {
        position: absolute; 
        top: 30px; 
        right: 30px; 
        width: 44px; 
        height: 44px;
        background: var(--input-bg);
        border: 1px solid var(--border-color); 
        border-radius: 50%;
        cursor: pointer; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        color: var(--text-primary); 
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        overflow: hidden; /* éšè—è¶…å‡ºéƒ¨åˆ†ä»¥å®ç°åˆ‡æ¢åŠ¨ç”» */
        z-index: 50;
    }

    /* æ‚¬åœæ•ˆæœ */
    .theme-toggle:hover { 
        background: var(--card-bg); 
        transform: translateY(-2px); 
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
        border-color: var(--ios-blue);
    }

    /* å›¾æ ‡é€šç”¨æ ·å¼ */
    .theme-icon {
        position: absolute;
        width: 22px;
        height: 22px;
        transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.4s ease;
    }

    /* æµ…è‰²æ¨¡å¼ä¸‹ï¼šæ˜¾ç¤ºæœˆäº®ï¼Œéšè—å¤ªé˜³ */
    [data-theme="light"] .icon-sun { opacity: 0; transform: rotate(90deg) scale(0.5); }
    [data-theme="light"] .icon-moon { opacity: 1; transform: rotate(0deg) scale(1); }

    /* æ·±è‰²æ¨¡å¼ä¸‹ï¼šæ˜¾ç¤ºå¤ªé˜³ï¼Œéšè—æœˆäº® */
    [data-theme="dark"] .icon-sun { opacity: 1; transform: rotate(0deg) scale(1); }
    [data-theme="dark"] .icon-moon { opacity: 0; transform: rotate(-90deg) scale(0.5); }

    /* Tooltip (æ‚¬åœæç¤ºæ–‡å­—) */
    .theme-toggle::after {
        content: attr(data-tooltip); /* è¯»å– data-tooltip å±æ€§ */
        position: absolute;
        top: 120%;
        right: 0;
        background: var(--tooltip-bg);
        color: var(--tooltip-text);
        padding: 6px 10px;
        border-radius: 8px;
        font-size: 0.75rem;
        font-weight: 500;
        white-space: nowrap;
        opacity: 0;
        transform: translateY(-8px);
        pointer-events: none;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }

    .theme-toggle:hover::after {
        opacity: 1;
        transform: translateY(0);
    }
    /* =========================================
       æ–°ç‰ˆä¸»é¢˜åˆ‡æ¢æŒ‰é’®æ ·å¼ (End)
       ========================================= */

    /* =========================================
       æ–°å¢ï¼šAPI çŠ¶æ€æ£€æµ‹æ ·å¼
       ========================================= */
    .api-status {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-bottom: 25px; /* åŸ subtitle margin-bottom: 30px */
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background-color: var(--text-secondary);
        animation: pulse 1.5s infinite ease-in-out;
    }

    .api-status span.text { color: var(--text-secondary); }

    /* æˆåŠŸçŠ¶æ€ */
    .api-status.success .status-dot {
        background-color: var(--ios-green);
        box-shadow: 0 0 8px rgba(52, 199, 89, 0.4);
        animation: none;
    }
    .api-status.success span.text { color: var(--ios-green); }

    /* å¤±è´¥çŠ¶æ€ */
    .api-status.error .status-dot {
        background-color: #FF3B30; /* iOS Red */
        box-shadow: 0 0 8px rgba(255, 59, 48, 0.4);
        animation: none;
    }
    .api-status.error span.text { color: #FF3B30; }

    @keyframes pulse { 0% { opacity: 0.4; transform: scale(0.9); } 50% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0.4; transform: scale(0.9); } }
    /* =========================================
       API çŠ¶æ€æ ·å¼ç»“æŸ
       ========================================= */

    h1 {
        text-align: center; font-size: 2.5rem; margin: 0 0 10px; font-weight: 700;
        letter-spacing: -0.02em;
        background: linear-gradient(135deg, var(--text-primary) 30%, var(--text-secondary));
        -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    }
    .subtitle { text-align: center; color: var(--text-secondary); margin-bottom: 15px; /* å‡å°‘ä¸‹è¾¹è·ä»¥å®¹çº³çŠ¶æ€æ¡ */ }

    /* Upload Box */
    .upload-box {
        border: 2px dashed var(--border-color); border-radius: 16px; padding: 50px 20px;
        text-align: center; background: rgba(128, 128, 128, 0.02); transition: all 0.3s; cursor: pointer;
    }
    .upload-box:hover { border-color: var(--ios-blue); background: rgba(0, 122, 255, 0.05); }
    .upload-icon { font-size: 3rem; margin-bottom: 15px; color: var(--ios-blue); }

    /* Controls Grid */
    .controls-grid {
        display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0;
        text-align: left;
    }
    .control-group { display: flex; flex-direction: column; gap: 8px; }
    .control-label { font-size: 0.9rem; font-weight: 600; color: var(--text-secondary); margin-left: 4px; }
    
    select, input, textarea {
        padding: 12px; font-size: 1rem; border-radius: 12px;
        border: 1px solid var(--border-color); background-color: var(--input-bg);
        color: var(--text-primary); outline: none; font-family: inherit; width: 100%;
        box-sizing: border-box; transition: border-color 0.2s;
    }
    select:focus, textarea:focus { border-color: var(--ios-blue); }
    textarea { resize: vertical; min-height: 80px; }

    /* Resume Banner */
    .resume-banner {
        background: rgba(255, 149, 0, 0.1); border: 1px solid var(--ios-orange); color: var(--ios-orange);
        padding: 12px 20px; border-radius: 12px; margin-bottom: 20px; display: none;
        align-items: center; justify-content: space-between; font-weight: 500;
    }
    .resume-banner button { margin: 0; padding: 6px 16px; font-size: 0.9rem; background: var(--ios-orange); }

    /* Preview Table */
    .preview-box {
        margin: 20px 0; height: 300px; overflow: auto;
        border: 1px solid var(--border-color); border-radius: 12px;
        background: var(--bg-color);
    }
    .preview-table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 0.9rem; table-layout: fixed; }
    .preview-table th {
        background: var(--table-header); position: sticky; top: 0; z-index: 10;
        font-weight: 600; color: var(--text-secondary); padding: 10px 16px;
        border-bottom: 1px solid var(--border-color); text-align: left;
    }
    .preview-table td {
        padding: 10px 16px; border-bottom: 1px solid var(--border-color);
        white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary);
    }
    .preview-table tr:hover td { background: var(--table-hover); }
    .col-translated { color: var(--ios-blue); font-weight: 500; background: rgba(0,122,255,0.05) !important; }

    /* Buttons & Progress */
    button {
        padding: 14px 32px; font-size: 1.05rem; border: none; border-radius: 999px;
        cursor: pointer; background: var(--ios-blue); color: white; font-weight: 500;
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3); transition: transform 0.2s;
    }
    button:hover { transform: scale(1.02); }
    button.secondary { background: rgba(128,128,128,0.2); color: var(--text-primary); box-shadow: none; }
    
    .status-bar {
        display: flex; justify-content: space-between; align-items: center;
        background: rgba(128,128,128,0.05); padding: 10px 20px; border-radius: 12px;
        margin-top: 20px; font-size: 0.9rem; color: var(--text-secondary);
    }

    progress { width: 100%; height: 8px; border-radius: 4px; overflow: hidden; border: none; background: rgba(128,128,128,0.2); }
    progress::-webkit-progress-value { background: var(--ios-blue); transition: width 0.3s; }

    .icon-svg { width: 40px; height: 40px; stroke: currentColor; fill: none; stroke-width: 1.5; }
</style>
</head>
<body data-theme="light">

<div class="container">
    <!-- 
       [æ›´æ–°] ä¸»é¢˜åˆ‡æ¢æŒ‰é’® 
       data-tooltip ç”¨äº CSS ::after ä¼ªå…ƒç´ æ˜¾ç¤ºæç¤ºæ–‡å­—
    -->
    <button class="theme-toggle" id="themeToggle" data-tooltip="åˆ‡æ¢æ·±è‰²æ¨¡å¼">
        <!-- å¤ªé˜³å›¾æ ‡ (æ·±è‰²æ¨¡å¼æ˜¾ç¤º) -->
        <svg class="theme-icon icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <circle cx="12" cy="12" r="5"></circle>
            <line x1="12" y1="1" x2="12" y2="3"></line>
            <line x1="12" y1="21" x2="12" y2="23"></line>
            <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
            <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
            <line x1="1" y1="12" x2="3" y2="12"></line>
            <line x1="21" y1="12" x2="23" y2="12"></line>
            <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
            <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
        </svg>
        <!-- æœˆäº®å›¾æ ‡ (æµ…è‰²æ¨¡å¼æ˜¾ç¤º) -->
        <svg class="theme-icon icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
        </svg>
    </button>

    <h1>Excel è¡¨æ ¼å†…å®¹ç¿»è¯‘å™¨ï¼ˆçº¯HTMLç‰ˆï¼‰| Qwen-Max</h1>
    <p class="subtitle">å¤šè¯­è¨€ Â· å¹¶å‘åŠ é€Ÿ Â· æ–­ç‚¹ç»­ä¼  Â· å¯¼å…¥å¯¼å‡º</p>

    <!-- [æ›´æ–°] API çŠ¶æ€æ˜¾ç¤ºæ¡ -->
    <div id="apiStatusDisplay" class="api-status">
        <span class="status-dot"></span>
        <span class="text">æ­£åœ¨æ£€æµ‹ API è¿æ¥...</span>
    </div>

    <!-- æ–­ç‚¹ç»­ä¼ æç¤º -->
    <div class="resume-banner" id="resumeBanner">
        <span>âš ï¸ æ£€æµ‹åˆ°ä¸Šæ¬¡æœªå®Œæˆçš„ç¿»è¯‘ä»»åŠ¡ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ</span>
        <div>
            <button class="secondary" id="discardSessionBtn" style="padding:6px 12px; font-size:0.8rem; margin-right:8px;">æ”¾å¼ƒ</button>
            <button id="resumeSessionBtn" style="padding:6px 12px; font-size:0.8rem;">ç»§ç»­ç¿»è¯‘</button>
        </div>
    </div>

    <div class="upload-box" id="uploadArea">
        <svg class="icon-svg upload-icon" viewBox="0 0 24 24"><path d="M21.2 15c.7 0 1.2.5 1.2 1.2v3.6c0 .7-.5 1.2-1.2 1.2H2.8c-.7 0-1.2-.5-1.2-1.2v-3.6c0-.7.5-1.2 1.2-1.2"></path><path d="M12 15V3"></path><path d="M7 8l5-5 5 5"></path></svg>
        <h3>ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼  Excel</h3>
        <input type="file" id="fileInput" accept=".xlsx,.xls" hidden>
    </div>

    <div id="config" style="display:none;">
        <div class="controls-grid">
            <div class="control-group">
                <span class="control-label">1. é€‰æ‹©éœ€ç¿»è¯‘çš„åˆ—</span>
                <select id="columnSelect"></select>
            </div>
            <div class="control-group">
                <span class="control-label">2. ç›®æ ‡è¯­è¨€</span>
                <select id="targetLang">
                    <option value="ä¸­æ–‡" selected>ğŸ‡¨ğŸ‡³ ä¸­æ–‡ (Chinese)</option>
                    <option value="è‹±è¯­">ğŸ‡ºğŸ‡¸ è‹±è¯­ (English)</option>
                    <option value="ç½—é©¬å°¼äºšè¯­">ğŸ‡·ğŸ‡´ ç½—é©¬å°¼äºšè¯­ (Romanian)</option>
                    <option value="æ³•è¯­">ğŸ‡«ğŸ‡· æ³•è¯­ (French)</option>
                    <option value="è¥¿ç­ç‰™è¯­">ğŸ‡ªğŸ‡¸ è¥¿ç­ç‰™è¯­ (Spanish)</option>
                    <option value="æ—¥è¯­">ğŸ‡¯ğŸ‡µ æ—¥è¯­ (Japanese)</option>
                </select>
            </div>
        </div>

        <div class="control-group" style="margin-bottom: 20px;">
            <span class="control-label">3. è‡ªå®šä¹‰æç¤ºè¯ (System Prompt)</span>
            <textarea id="customPrompt" placeholder="ä¾‹å¦‚ï¼šè¯·ç¿»è¯‘ä¸ºç”µå•†é£æ ¼ï¼Œä¿æŒä¸“ä¸šæœ¯è¯­ä¸ç¿»è¯‘...">ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¿»è¯‘åŠ©æ‰‹ã€‚è¯·å°†ä»¥ä¸‹æ¯è¡Œå†…å®¹ç¿»è¯‘æˆ{lang}ï¼Œä¸“æœ‰åè¯ã€å“ç‰Œã€å‹å·ç­‰ä¸€å¾‹ä¿ç•™åŸæ ·ï¼Œåªè¿”å›çº¯ç¿»è¯‘ç»“æœï¼Œæ¯è¡Œå¯¹åº”ä¸€è¡Œï¼Œä¸åŠ ä»»ä½•ç¼–å·ã€‚</textarea>
        </div>

        <!-- è´¹ç”¨é¢„ä¼°æ˜¾ç¤º -->
        <div class="status-bar" id="costEstimate" style="background: rgba(0,122,255,0.05); color: var(--ios-blue);">
            <span>ğŸ“Š é€‰ä¸­åˆ—å…± 0 å­—ç¬¦</span>
            <span>é¢„è®¡æ¶ˆè€—: ~0 Token</span>
        </div>

        <div class="preview-box" id="previewBox">
            <div class="preview-header" style="padding:10px 16px; border-bottom:1px solid var(--border-color); font-size:0.85rem; color:var(--text-secondary);">
                å®æ—¶é¢„è§ˆï¼ˆå‰ 20 è¡Œï¼‰
            </div>
            <table class="preview-table" id="previewTable">
                <thead id="previewThead"></thead>
                <tbody id="previewTbody"></tbody>
            </table>
        </div>

        <div style="text-align:center; margin-top:30px;">
            <button id="startBtn">ğŸš€ å¼€å§‹å¹¶å‘ç¿»è¯‘</button>
        </div>
    </div>

    <div id="progress" style="display:none; margin-top:30px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.95rem;">
            <span id="progressStatus">æ­£åœ¨å¤„ç†...</span>
            <span id="progressText">0 / 0</span>
        </div>
        <progress id="progressBar" value="0" max="100"></progress>
    </div>

    <div id="result" style="display:none; text-align:center; margin-top:40px;">
        <h2 style="color:var(--ios-green)">ğŸ‰ ç¿»è¯‘å®Œæˆ</h2>
        <button class="success" id="downloadBtn" style="background:var(--ios-green)">ä¸‹è½½ Excel æ–‡ä»¶</button>
    </div>

    <div style="text-align:center; margin-top:50px; opacity:0.5; font-size:0.8rem;">
        Powered by Qwen-Max Â· 3x Concurrency
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script>
// ============ æ ¸å¿ƒé…ç½® ============
const _0x4e3d = ['c2stZDJhZWYyY2U0YjIzNDM5MGJiZDkzODUxNjlhZDMxNmM='];
const API_KEY = atob(_0x4e3d[0]);
const BATCH_SIZE = 20; // æ¯æ‰¹æ¬¡æ•°é‡
const CONCURRENCY_LIMIT = 3; // å¹¶å‘è¯·æ±‚æ•° (3ä¸ªè¯·æ±‚åŒæ—¶å‘)

// ============ å…¨å±€å˜é‡ ============
let rawData = [];
let toTranslate = []; // å¾…ç¿»è¯‘çš„çº¯æ–‡æœ¬æ•°ç»„
let translatedResults = []; // å­˜å‚¨ç¿»è¯‘ç»“æœ
let fileKey = ""; // ç”¨äºç¼“å­˜çš„å”¯ä¸€Key (æ–‡ä»¶å+å¤§å°)

// ============ ä¸»é¢˜é€»è¾‘ (å·²æ›´æ–°ä»¥æ”¯æŒæ–°æŒ‰é’®å’Œæç¤º) ============
const themeToggle = document.getElementById('themeToggle');
const body = document.body;

function updateThemeUI() {
    const isDark = body.getAttribute('data-theme') === 'dark';
    // æ›´æ–° Tooltip æ–‡å­—: å¦‚æœå½“å‰æ˜¯æš—è‰²ï¼Œæç¤º"åˆ‡æ¢æµ…è‰²"ï¼Œåä¹‹äº¦ç„¶
    themeToggle.setAttribute('data-tooltip', isDark ? 'åˆ‡æ¢æµ…è‰²æ¨¡å¼' : 'åˆ‡æ¢æ·±è‰²æ¨¡å¼');
}

themeToggle.onclick = () => {
    const isDark = body.getAttribute('data-theme') === 'dark';
    const newTheme = isDark ? 'light' : 'dark';
    body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    updateThemeUI();
};

// åˆå§‹åŒ–ä¸»é¢˜
if (localStorage.getItem('theme') === 'dark' || (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) body.setAttribute('data-theme', 'dark');
updateThemeUI(); // åˆå§‹åŒ– Tooltip

// ============ [æ›´æ–°] API çŠ¶æ€æ£€æµ‹é€»è¾‘ ============
async function checkApiConnection() {
    const statusContainer = document.getElementById('apiStatusDisplay');
    const statusText = statusContainer.querySelector('.text');
    
    try {
        // ä½¿ç”¨ä¸€ä¸ªæå…¶è½»é‡çš„è¯·æ±‚ (token=1) æµ‹è¯•è¿é€šæ€§
        // ä½¿ç”¨ OpenAI å…¼å®¹æ¥å£æ ¼å¼
        const response = await fetch('https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions', {
            method: 'POST',
            headers: { 
                'Authorization': 'Bearer ' + API_KEY, 
                'Content-Type': 'application/json' 
            },
            body: JSON.stringify({
                model: "qwen-max",
                messages: [{ role: "user", content: "hi" }],
                max_tokens: 1 // æœ€å°åŒ– token æ¶ˆè€—
            })
        });

        if (response.ok) {
            statusContainer.className = 'api-status success';
            statusText.textContent = 'åƒé—® Â· Qwen-Max å·²å°±ç»ª';
        } else {
            throw new Error(`Status ${response.status}`);
        }
    } catch (e) {
        console.error("API Connection Check Failed:", e);
        statusContainer.className = 'api-status error';
        statusText.textContent = 'åƒé—® Â· Qwen-Max æ— æ³•è¿æ¥';
    }
}

// ============ åˆå§‹åŒ–æ£€æŸ¥ï¼šæ–­ç‚¹ç»­ä¼ ä¸APIæ£€æµ‹ ============
window.onload = () => {
    // 1. è¿è¡Œ API æ£€æŸ¥
    checkApiConnection();

    // 2. æ£€æŸ¥æ–­ç‚¹ç»­ä¼ 
    const savedSession = localStorage.getItem('translation_session_meta');
    if (savedSession) {
        document.getElementById('resumeBanner').style.display = 'flex';
        document.getElementById('uploadArea').style.display = 'none';
    }
};

document.getElementById('discardSessionBtn').onclick = () => {
    localStorage.removeItem('translation_session_meta');
    localStorage.removeItem('translation_session_data');
    localStorage.removeItem('translation_session_raw');
    location.reload();
};

document.getElementById('resumeSessionBtn').onclick = () => {
    const meta = JSON.parse(localStorage.getItem('translation_session_meta'));
    const data = JSON.parse(localStorage.getItem('translation_session_data'));
    const raw = JSON.parse(localStorage.getItem('translation_session_raw'));
    
    rawData = raw;
    translatedResults = data;
    toTranslate = meta.toTranslate;
    fileKey = meta.fileKey;

    // æ¢å¤ UI çŠ¶æ€
    document.getElementById('resumeBanner').style.display = 'none';
    document.getElementById('config').style.display = 'none';
    startTranslationProcess(true); // true è¡¨ç¤ºæ˜¯æ¢å¤ä»»åŠ¡
};

// ============ æ–‡ä»¶å¤„ç† ============
const uploadArea = document.getElementById('uploadArea');
const fileInput = document.getElementById('fileInput');

uploadArea.onclick = () => fileInput.click();
uploadArea.ondragover = e => { e.preventDefault(); uploadArea.classList.add('dragover'); }
uploadArea.ondragleave = () => uploadArea.classList.remove('dragover');
uploadArea.ondrop = e => { e.preventDefault(); if (e.dataTransfer.files[0]) handleFile(e.dataTransfer.files[0]); };
fileInput.onchange = e => { if (e.target.files[0]) handleFile(e.target.files[0]); };

function handleFile(file) {
    fileKey = `${file.name}_${file.size}`;
    const reader = new FileReader();
    reader.onload = function(e) {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, {type: 'array'});
        rawData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header:1, defval:""});

        // å¡«å……åˆ—é€‰æ‹©
        const select = document.getElementById('columnSelect');
        select.innerHTML = '';
        rawData[0].forEach((header, idx) => select.appendChild(new Option(header || `ç¬¬ ${idx+1} åˆ—`, idx)));
        
        // è§¦å‘ä¸€æ¬¡é¢„ä¼°
        updateCostEstimate();
        
        uploadArea.style.display = 'none';
        document.getElementById('config').style.display = 'block';
        updatePreviewTable();
    };
    reader.readAsArrayBuffer(file);
}

// ============ äº¤äº’é€»è¾‘æ›´æ–° ============
document.getElementById('columnSelect').onchange = () => {
    updateCostEstimate();
    updatePreviewTable();
};

function updateCostEstimate() {
    const colIdx = parseInt(document.getElementById('columnSelect').value);
    const textData = rawData.slice(1).map(r => (r[colIdx]||'').toString());
    const totalChars = textData.join('').length;
    // ç²—ç•¥ä¼°ç®—ï¼šä¸­æ–‡çº¦ 1 char = 1 tokenï¼Œè‹±æ–‡ 4 char = 1 tokenã€‚å–ä¿å®ˆå€¼ 1.3 å€
    const estTokens = Math.ceil(totalChars * 1.3);
    
    document.getElementById('costEstimate').innerHTML = `
        <span>ğŸ“Š é€‰ä¸­åˆ—å…± ${totalChars.toLocaleString()} å­—ç¬¦</span>
        <span>âš¡ï¸ é¢„è®¡æ¶ˆè€—: ~${estTokens.toLocaleString()} Token</span>
    `;
}

function updatePreviewTable() {
    const colIdx = parseInt(document.getElementById('columnSelect').value);
    const thead = document.getElementById('previewThead');
    const tbody = document.getElementById('previewTbody');
    
    thead.innerHTML = `<tr><th>åŸæ–‡ (${rawData[0][colIdx]})</th><th>å®æ—¶ç¿»è¯‘é¢„è§ˆ</th></tr>`;
    tbody.innerHTML = '';

    const maxRows = Math.min(20, rawData.length - 1);
    for (let i = 1; i <= maxRows; i++) {
        const tr = document.createElement('tr');
        tr.id = `preview-row-${i-1}`; // æ ‡è®° ID æ–¹ä¾¿å®æ—¶æ›´æ–°
        tr.innerHTML = `
            <td title="${rawData[i][colIdx]}">${rawData[i][colIdx]}</td>
            <td class="col-translated" id="preview-cell-${i-1}">...</td>
        `;
        tbody.appendChild(tr);
    }
}

// ============ æ ¸å¿ƒç¿»è¯‘æµç¨‹ (å¹¶å‘+é‡è¯•) ============
document.getElementById('startBtn').onclick = () => {
    const colIdx = parseInt(document.getElementById('columnSelect').value);
    toTranslate = rawData.slice(1).map(row => (row[colIdx] || '').toString().trim());
    
    // åˆå§‹åŒ–ç»“æœæ•°ç»„
    translatedResults = new Array(toTranslate.length).fill(null); // null ä»£è¡¨æœªç¿»è¯‘

    // ä¿å­˜ Session åˆå§‹çŠ¶æ€
    saveSessionMeta(toTranslate, fileKey);
    saveSessionRaw(rawData);
    
    startTranslationProcess(false);
};

async function startTranslationProcess(isResume) {
    document.getElementById('config').style.display = 'none';
    document.getElementById('progress').style.display = 'block';
    
    // æ„é€ æ‰¹æ¬¡ç´¢å¼• [0, 20, 40...]
    let batches = [];
    for (let i = 0; i < toTranslate.length; i += BATCH_SIZE) {
        // å¦‚æœæ˜¯æ–­ç‚¹ç»­ä¼ ï¼Œè·³è¿‡å·²ç»æœ‰ç»“æœçš„æ‰¹æ¬¡
        if (isResume && translatedResults[i] !== null && translatedResults[i] !== undefined && translatedResults[i] !== "") {
            continue; 
        }
        batches.push(i);
    }

    if (batches.length === 0 && isResume) {
        finishProcess();
        return;
    }

    // å¹¶å‘æ§åˆ¶å™¨
    let activeWorkers = 0;
    let batchIndex = 0;
    const totalBatches = batches.length;
    let completedBatches = 0;

    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const progressStatus = document.getElementById('progressStatus');
    
    // åŸºç¡€è¿›åº¦ (å¦‚æœæ˜¯ç»­ä¼ ï¼Œå…ˆè®¾ç½®è¿›åº¦æ¡)
    let initialProgress = ((toTranslate.length - batches.length * BATCH_SIZE) / toTranslate.length) * 100;
    if (!isResume) initialProgress = 0;

    return new Promise((resolve) => {
        function next() {
            // æ‰€æœ‰æ‰¹æ¬¡åˆ†å‘å®Œæ¯•ï¼Œä¸”æ‰€æœ‰ worker å½’ä½
            if (batchIndex >= batches.length && activeWorkers === 0) {
                finishProcess();
                resolve();
                return;
            }

            while (activeWorkers < CONCURRENCY_LIMIT && batchIndex < batches.length) {
                const startIdx = batches[batchIndex++];
                activeWorkers++;
                
                const batchData = toTranslate.slice(startIdx, startIdx + BATCH_SIZE);
                
                // æ‰§è¡Œç¿»è¯‘
                processBatch(batchData, startIdx).then(() => {
                    activeWorkers--;
                    completedBatches++;
                    
                    // æ›´æ–°è¿›åº¦ UI
                    const currentCount = Math.min(toTranslate.length, startIdx + BATCH_SIZE); // ç²—ç•¥æ˜¾ç¤º
                    // æ›´ç²¾ç¡®çš„è¿›åº¦è®¡ç®—
                    const totalDone = toTranslate.length - ((totalBatches - completedBatches) * BATCH_SIZE);
                    const percent = Math.min(100, (totalDone / toTranslate.length) * 100);
                    
                    progressBar.value = percent;
                    progressText.textContent = `${Math.floor(percent)}%`;
                    progressStatus.textContent = `æ­£åœ¨å¹¶å‘ç¿»è¯‘... (å‰©ä½™ ${totalBatches - completedBatches} æ‰¹)`;

                    next(); // é€’å½’è°ƒç”¨ï¼Œå¡«è¡¥ç©ºé—² worker
                });
            }
        }
        next();
    });
}

// å¤„ç†å•ä¸ªæ‰¹æ¬¡
async function processBatch(texts, startIdx) {
    // 1. è¿‡æ»¤ç©ºè¡Œï¼Œä¿ç•™ç´¢å¼•æ˜ å°„
    const validItems = texts.map((t, i) => ({ text: t, relIdx: i })).filter(item => item.text.length > 0);
    
    if (validItems.length === 0) {
        // å…¨æ˜¯ç©ºè¡Œï¼Œç›´æ¥å¡«å……
        texts.forEach((_, i) => updateResultAndUI(startIdx + i, ""));
        saveSessionData();
        return;
    }

    // 2. å‡†å¤‡ Prompt
    const targetLang = document.getElementById('targetLang').value;
    const userPromptTemplate = document.getElementById('customPrompt').value;
    const systemPrompt = userPromptTemplate.replace('{lang}', targetLang);

    // 3. è°ƒç”¨ API (å¸¦é‡è¯•)
    const apiRes = await fetchWithRetry(validItems.map(v => v.text), systemPrompt);
    
    if (apiRes.success) {
        const translations = apiRes.translations;
        
        // 4. å›å¡«æ•°æ®
        let transPtr = 0;
        for (let i = 0; i < texts.length; i++) {
            const globalIdx = startIdx + i;
            if (texts[i].length === 0) {
                updateResultAndUI(globalIdx, "");
            } else {
                const resText = translations[transPtr++] || "ç¿»è¯‘å¤±è´¥";
                updateResultAndUI(globalIdx, resText);
            }
        }
        // 5. ä¿å­˜ç¼“å­˜
        saveSessionData();
    } else {
        // æ‰¹æ¬¡å¤±è´¥ï¼Œå¡«å…¥é”™è¯¯ä¿¡æ¯ä½†ä¸ä¸­æ–­æµç¨‹
        texts.forEach((_, i) => updateResultAndUI(startIdx + i, "[ERROR] " + apiRes.error));
    }
}

// æ›´æ–°ç»“æœæ•°ç»„å¹¶åˆ·æ–°é¢„è§ˆ UI
function updateResultAndUI(index, text) {
    translatedResults[index] = text;
    // å¦‚æœè¯¥è¡Œåœ¨é¢„è§ˆè¡¨æ ¼çš„å¯è§†èŒƒå›´å†… (å‰20è¡Œ)ï¼Œæ›´æ–°å®ƒ
    const uiCell = document.getElementById(`preview-cell-${index}`);
    if (uiCell) {
        uiCell.textContent = text;
        uiCell.style.color = 'var(--text-primary)';
        uiCell.parentElement.style.backgroundColor = 'rgba(52, 199, 89, 0.1)'; // Flash green
        setTimeout(() => uiCell.parentElement.style.backgroundColor = '', 500);
    }
}

// æ™ºèƒ½é‡è¯• Fetch
async function fetchWithRetry(texts, systemPrompt, retries = 3) {
    const url = 'https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions';
    const payload = {
        model: "qwen-max",
        messages: [
            { role: "system", content: systemPrompt },
            { role: "user", content: texts.join('\n') }
        ],
        temperature: 0.3
    };

    for (let attempt = 1; attempt <= retries; attempt++) {
        try {
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + API_KEY, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                // å¦‚æœæ˜¯ 429 (é™æµ) æˆ– 5xx (æœåŠ¡å™¨é”™è¯¯)ï¼Œç­‰å¾…åé‡è¯•
                if (response.status === 429 || response.status >= 500) {
                    console.warn(`Attempt ${attempt} failed: ${response.status}. Retrying...`);
                    await new Promise(r => setTimeout(r, 3000 * attempt)); // é€’å¢ç­‰å¾… 3s, 6s, 9s
                    continue; 
                }
                throw new Error(`API Error ${response.status}`);
            }

            const data = await response.json();
            const content = data.choices[0].message.content.trim();
            // åˆ†å‰²è¡Œï¼Œå¤„ç†å¯èƒ½å°‘è¿”å›çš„æƒ…å†µ
            let lines = content.split('\n').map(l => l.trim());
            // ç®€å•å¯¹é½ï¼šå¦‚æœè¿”å›è¡Œæ•°å°‘äºè¯·æ±‚è¡Œæ•°ï¼Œè¡¥ç©º
            /* æ³¨æ„ï¼šQwen å¯èƒ½ä¼šåˆå¹¶è¡Œï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼Œå®é™…ç”Ÿäº§ç¯å¢ƒéœ€è¦æ›´å¤æ‚çš„å¯¹é½é€»è¾‘æˆ–å•è¡Œç¿»è¯‘ */
            /* è¿™é‡Œçš„é€»è¾‘å‡è®¾æ¨¡å‹ä¸¥æ ¼éµå¾ª instruction "æ¯è¡Œå¯¹åº”ä¸€è¡Œ" */
            return { success: true, translations: lines };

        } catch (error) {
            if (attempt === retries) return { success: false, error: error.message };
        }
    }
}

// ============ ç»“æŸå¤„ç† ============
function finishProcess() {
    // ç»„è£…æœ€ç»ˆ Excel
    const colIdx = parseInt(document.getElementById('columnSelect').value || 0);
    const newColIdx = rawData[0].length;
    
    // æ·»åŠ è¡¨å¤´
    const langName = document.getElementById('targetLang').value;
    rawData[0][newColIdx] = rawData[0][colIdx] + `_${langName}`;

    // å¡«å……å†…å®¹
    for (let i = 0; i < toTranslate.length; i++) {
        rawData[i + 1][newColIdx] = translatedResults[i];
    }

    // æ¸…é™¤ç¼“å­˜
    localStorage.removeItem('translation_session_meta');
    localStorage.removeItem('translation_session_data');
    localStorage.removeItem('translation_session_raw');

    document.getElementById('progress').style.display = 'none';
    document.getElementById('result').style.display = 'block';
}

document.getElementById('downloadBtn').onclick = () => {
    const ws = XLSX.utils.aoa_to_sheet(rawData);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "ç¿»è¯‘ç»“æœ");
    XLSX.writeFile(wb, `ç¿»è¯‘å®Œæˆ_${new Date().toISOString().slice(0,10)}.xlsx`);
};

// ============ æœ¬åœ°å­˜å‚¨è¾…åŠ©å‡½æ•° ============
function saveSessionMeta(toTranslateArr, key) {
    const meta = { toTranslate: toTranslateArr, fileKey: key, date: Date.now() };
    localStorage.setItem('translation_session_meta', JSON.stringify(meta));
}
function saveSessionRaw(raw) {
    // æ³¨æ„ï¼šå¦‚æœæ–‡ä»¶å·¨å¤§ï¼ŒlocalStorage å¯èƒ½ä¼šçˆ†ï¼ˆé€šå¸¸é™åˆ¶ 5MBï¼‰ã€‚
    // å®é™…ç”Ÿäº§å»ºè®®ç”¨ IndexedDBï¼Œè¿™é‡Œä¸ºäº†å•æ–‡ä»¶ç®€å•æ€§ä½¿ç”¨ try-catch
    try { localStorage.setItem('translation_session_raw', JSON.stringify(raw)); } catch(e) { console.warn("Storage full"); }
}
function saveSessionData() {
    localStorage.setItem('translation_session_data', JSON.stringify(translatedResults));
}

</script>
</body>

</html>
