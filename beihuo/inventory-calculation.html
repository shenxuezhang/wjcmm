<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SHEIN备货下单计算器</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="container">
    <h1>
      <svg class="title-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
        <path d="M12 2L3 7V17L12 22L21 17V7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M3 7L12 12L21 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M12 22V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        <path d="M7 10L12 13L17 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      SHEIN备货下单计算器
    </h1>

    <!-- Toast提示容器 -->
    <div id="toastContainer" class="toast-container"></div>

    <!-- 功能卡片区域 -->
    <div class="function-cards-wrapper">
      <!-- 文件上传区域 -->
      <div class="upload-section" id="uploadSection">
        <div class="card-header">
          <h2>文件操作<span id="fileNameDisplay" class="file-name-display"></span></h2>
          <button class="settings-btn" id="settingsBtn" onclick="openSettingsModal()" title="设置淘汰阈值">
            ⚙
          </button>
        </div>
        <div class="card-content">
          <div class="file-input-wrapper">
            <input type="file" id="fileInput" accept=".xls,.xlsx" style="display: none;">
            <button class="btn btn-primary" id="fileSelectBtn" onclick="document.getElementById('fileInput').click()">
              📁 选择Excel文件<span id="dataCountDisplay"></span>
            </button>
            <button class="btn btn-secondary" onclick="clearData()">清空数据</button>
            <button class="btn btn-danger" id="deleteBtn" onclick="deleteSelectedRows()" style="display: none;" disabled>
              删除选中
            </button>
            <button class="btn btn-primary" id="exportBtn" onclick="exportToExcel()" style="display: none;">
              导出数据
            </button>
          </div>
        </div>
      </div>

      <!-- 筛选和搜索栏 -->
      <div class="filter-section" id="filterSection" style="display: none;">
        <div class="card-header">
          <h2>筛选与搜索</h2>
        </div>
        <div class="card-content">
      <div class="filter-bar">
        <div class="filter-group">
          <label>质量等级：</label>
          <div class="quality-level-filter-wrapper">
            <button class="btn btn-secondary quality-level-toggle" id="qualityLevelToggle" onclick="toggleQualityLevelDropdown()">
              <span id="qualityLevelText">请选择</span>
            </button>
            <div class="quality-level-dropdown" id="qualityLevelDropdown" style="display: none;">
              <div class="quality-level-options" id="qualityLevelOptions">
              </div>
              <div class="quality-level-actions">
                <button class="btn btn-sm btn-primary" onclick="selectAllQualityLevels()">全选</button>
                <button class="btn btn-sm btn-secondary" onclick="clearQualityLevels()">清空</button>
              </div>
            </div>
          </div>
        </div>
        <div class="filter-group">
          <label>实际建议单数：</label>
          <select id="actualOrderOperator" class="filter-operator">
            <option value="=">等于</option>
            <option value=">">大于</option>
            <option value="<" selected>小于</option>
            <option value=">=">大于等于</option>
            <option value="<=">小于等于</option>
          </select>
          <div class="input-wrapper filter-input-wrapper">
          <input type="number" id="actualOrderValue" class="filter-input" placeholder="输入数值">
            <button class="input-clear-btn" type="button" onclick="clearFilterInput('actualOrderValue')">×</button>
          </div>
        </div>
        <button class="btn btn-secondary" onclick="clearFilters()">清除筛选</button>
      </div>
      <div class="search-bar">
        <div class="search-group">
          <label>供货方号：</label>
          <div class="input-wrapper search-input-wrapper">
          <input type="text" id="supplierCodeSearch" class="search-input" placeholder="输入供货方号">
            <button class="input-clear-btn" type="button" onclick="clearSearchInput('supplierCodeSearch')">×</button>
          </div>
        </div>
        <div class="search-group">
          <label>SKC：</label>
          <div class="input-wrapper search-input-wrapper">
          <input type="text" id="skcSearch" class="search-input" placeholder="输入SKC">
            <button class="input-clear-btn" type="button" onclick="clearSearchInput('skcSearch')">×</button>
          </div>
          <button class="btn btn-primary" onclick="searchAll()">🔍 搜索</button>
        </div>
        <button class="btn btn-secondary" onclick="clearSearch()">清除搜索</button>
      </div>
        </div>
      </div>

      <!-- 数据统计卡片 -->
      <div class="statistics-section" id="statisticsSection" style="display: none;">
        <div class="card-header">
          <h2>数据统计</h2>
        </div>
        <div class="card-content">
          <div class="statistics-list">
            <div class="statistics-item">
              <span class="statistics-label">导入总数据量</span>
              <span class="statistics-value" id="statTotalImported">0 <span style="font-size: 14px; font-weight: 400; color: #656d76;">条</span></span>
            </div>
            <div class="statistics-item">
              <span class="statistics-label">淘汰数据量</span>
              <span class="statistics-value statistics-eliminated" id="statEliminated">0 <span style="font-size: 14px; font-weight: 400; color: #656d76;">条</span></span>
              <div class="statistics-progress-wrapper" id="statEliminatedProgress" style="display: none;">
                <div class="statistics-progress-bar">
                  <div class="statistics-progress-fill eliminated" id="statEliminatedProgressFill" style="width: 0%;"></div>
                </div>
                <span class="statistics-progress-text" id="statEliminatedProgressText">0%</span>
              </div>
            </div>
            <div class="statistics-item">
              <span class="statistics-label">入围数据量</span>
              <span class="statistics-value statistics-qualified" id="statQualified">0 <span style="font-size: 14px; font-weight: 400; color: #656d76;">条</span></span>
              <div class="statistics-progress-wrapper" id="statQualifiedProgress" style="display: none;">
                <div class="statistics-progress-bar">
                  <div class="statistics-progress-fill qualified" id="statQualifiedProgressFill" style="width: 0%;"></div>
                </div>
                <span class="statistics-progress-text" id="statQualifiedProgressText">0%</span>
              </div>
            </div>
            <div class="statistics-item">
              <span class="statistics-label">已删除数据量</span>
              <span class="statistics-value statistics-deleted" id="statDeleted">0 <span style="font-size: 14px; font-weight: 400; color: #656d76;">条</span></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 骨架屏 -->
    <div class="skeleton-wrapper" id="skeletonWrapper" style="display: none;">
      <div id="skeletonContent"></div>
    </div>

    <!-- 数据表格 -->
    <div class="table-wrapper" id="tableWrapper" style="display: none;">
      <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading-content">
          <div class="loading-spinner"></div>
          <div class="loading-text" id="loadingText">正在加载...</div>
          <div class="progress-bar-wrapper" id="progressBarWrapper" style="display: none;">
            <div class="progress-bar">
              <div class="progress-bar-fill" id="progressBarFill" style="width: 0%;"></div>
            </div>
            <div class="progress-text" id="progressText">0%</div>
          </div>
        </div>
      </div>
      <table id="dataTable">
        <thead>
          <tr>
            <th class="checkbox-header">
              <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this.checked)">
              <label for="selectAllCheckbox">选择框</label>
            </th>
            <th>图片</th>
            <th>供货方号</th>
            <th>SKC</th>
            <th>SKU</th>
            <th>属性集</th>
            <th>质量等级</th>
            <th>SHEIN仓库存</th>
            <th>
              预测日销
              <span class="formula-icon" title="计算公式">
                ?
                <span class="formula-tooltip">
                  <span class="formula-tooltip-title">预测日销计算公式</span>
                  <span class="formula-tooltip-content">
                    <span class="formula-tooltip-formula">预测日销 = 近7天销量 ÷ 7</span>
                  </span>
                </span>
              </span>
            </th>
            <th>实际建议单数</th>
            <th>
              建议下单数
              <span class="formula-icon" title="计算公式">
                ?
                <span class="formula-tooltip">
                  <span class="formula-tooltip-title">建议下单数计算公式</span>
                  <span class="formula-tooltip-content">
                    <span class="formula-tooltip-formula">建议下单数 = 预测日销 × (货期 + 备货天数) - 待发货 - 在途 - 待上架 - SHEIN仓库存</span>
                    <div style="margin-top: 8px; font-size: 12px; color: #8c959f;">
                      四舍五入规则：按5的倍数向上取整；若计算结果 &lt; 5，则直接取5件
                    </div>
                  </span>
                </span>
              </span>
            </th>
          </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
      </table>
    </div>

    <div id="emptyState" class="empty-state">
      <div class="empty-state-icon" id="emptyStateIcon">
        <svg class="empty-icon-svg" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <rect x="8" y="12" width="48" height="40" rx="4" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
          <path d="M8 20H56" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"/>
          <path d="M20 28V52" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M32 28V52" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <path d="M44 28V52" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          <circle cx="20" cy="36" r="2" fill="currentColor"/>
          <circle cx="32" cy="40" r="2" fill="currentColor"/>
          <circle cx="44" cy="38" r="2" fill="currentColor"/>
        </svg>
      </div>
      <div id="emptyStateText">正在加载Excel解析库...</div>
    </div>
  </div>

  <!-- 错误提示模态框 -->
  <div id="errorModal" class="error-modal" style="display: none;">
    <div class="error-modal-content">
      <div class="error-modal-header">
        <h3 id="errorModalTitle">错误</h3>
        <button class="error-modal-close" onclick="closeErrorModal()">&times;</button>
      </div>
      <div class="error-modal-body">
        <div class="error-icon">⚠️</div>
        <div class="error-message" id="errorModalMessage"></div>
        <div class="error-details" id="errorModalDetails" style="display: none;"></div>
      </div>
      <div class="error-modal-footer">
        <button class="btn btn-primary" onclick="closeErrorModal()">确定</button>
      </div>
    </div>
  </div>

  <!-- 确认提示模态框 -->
  <div id="confirmModal" class="confirm-modal" style="display: none;">
    <div class="confirm-modal-content">
      <div class="confirm-modal-header">
        <div class="confirm-icon-wrapper">
          <div class="confirm-icon">⚠</div>
        </div>
        <h3>确认删除</h3>
        <button class="confirm-modal-close" onclick="closeConfirmModal()" aria-label="关闭">×</button>
      </div>
      <div class="confirm-modal-body">
        <div class="confirm-message" id="confirmModalMessage"></div>
        <div class="confirm-warning">
          <span class="confirm-warning-icon">ℹ</span>
          <span class="confirm-warning-text">此操作不可撤销，请谨慎操作</span>
        </div>
      </div>
      <div class="confirm-modal-footer">
        <button class="btn btn-secondary" onclick="closeConfirmModal()">取消</button>
        <button class="btn btn-danger" id="confirmModalOkBtn" onclick="confirmModalCallback()">确认删除</button>
      </div>
    </div>
  </div>

  <!-- 设置模态框 -->
  <div id="settingsModal" class="settings-modal" style="display: none;">
    <div class="settings-modal-content">
      <div class="settings-modal-header">
        <h3>设置淘汰阈值</h3>
        <button class="settings-modal-close" onclick="closeSettingsModal()">×</button>
      </div>
      <div class="settings-modal-body">
        <div class="settings-form-group">
          <label for="thresholdInput">淘汰阈值：</label>
          <input type="number" id="thresholdInput" class="settings-input" value="0" step="0.01">
          <p class="settings-hint">当建议下单数（未四舍五入）小于此值时，数据将被淘汰不显示。默认值为0。</p>
        </div>
      </div>
      <div class="settings-modal-footer">
        <button class="btn btn-secondary" onclick="closeSettingsModal()">取消</button>
        <button class="btn btn-primary" onclick="saveSettings()">保存</button>
      </div>
    </div>
  </div>

  <!-- 按顺序加载JavaScript模块 -->
  <script src="js/config/constants.js"></script>
  <script src="js/utils/xlsxLoader.js"></script>
  <script src="js/utils/fileParser.js"></script>
  <script src="js/utils/calculator.js"></script>
  <script src="js/utils/filterService.js"></script>
  <script src="js/utils/tableRenderer.js"></script>
  <script src="js/services/excelService.js"></script>
  <script src="js/app.js"></script>
</body>
</html>
