<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFæ¡ç å·¥ä½œå° SmartLens Pro - ä¼ä¸šçº§ </title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ QuaggaJS æ ¸å¿ƒåº“ -->
    <script src="https://unpkg.com/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
    <!-- å¼•å…¥ PDF.js ç”¨äºè§£æ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root { font-family: 'Inter', sans-serif; }
        
        /* ç‚¹é˜µèƒŒæ™¯å›¾æ¡ˆ */
        .bg-dot-pattern {
            background-image: radial-gradient(#e5e7eb 1.5px, transparent 1.5px);
            background-size: 20px 20px;
        }

        #canvasHidden { display: none; } 
        
        .preview-container { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #canvasOverlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
        }
        #previewImg {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
            transition: opacity 0.3s ease;
        }
        
        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        textarea::-webkit-scrollbar { width: 6px; height: 6px; }
        textarea::-webkit-scrollbar-track { background: transparent; }
        textarea::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        textarea::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eff6ff', 
                            100: '#dbeafe', 
                            500: '#3b82f6', 
                            600: '#2563eb', 
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body class="bg-[#f3f4f6] text-slate-800 min-h-screen flex flex-col antialiased selection:bg-brand-500/30">

    <!-- 1. é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-white h-[72px] border-b border-slate-200 px-6 flex items-center justify-between sticky top-0 z-40 shadow-sm shrink-0">
        <div class="flex items-center gap-4">
            <!-- å“ç‰Œ Logo -->
            <div class="w-10 h-10 bg-brand-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">SmartLens PDFæ¡ç å¤„ç†å·¥ä½œå° <span class="text-brand-600">Pro v3.0</span></h1>
                <p class="text-xs text-slate-400 font-medium">æ™ºèƒ½è¯†åˆ« Â· ç²¾å‡†æå– Â· é«˜æ•ˆè‡ªåŠ¨åŒ–</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <!-- è®¾ç½®æŒ‰é’® -->
            <button onclick="toggleSettings()" class="p-2 text-slate-400 hover:text-slate-600 transition-colors rounded-full hover:bg-slate-100">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
            </button>
            
            <!-- API çŠ¶æ€èƒ¶å›Š -->
            <div id="apiStatusIndicator" onclick="toggleSettings()" class="flex items-center gap-2 px-4 py-1.5 bg-slate-100 text-slate-500 rounded-full text-xs font-bold tracking-wide cursor-pointer transition-colors border border-transparent">
                <span id="apiStatusDot" class="w-2 h-2 rounded-full bg-slate-400"></span>
                <span id="apiStatusText">API CONFIG</span>
            </div>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="flex-1 max-w-[1920px] w-full mx-auto p-6 grid grid-cols-12 gap-6 overflow-hidden min-h-0">

        <!-- å·¦ä¾§æ : æ•°æ®è½½å…¥ä¸æ§åˆ¶ -->
        <aside class="col-span-12 lg:col-span-4 xl:col-span-3 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden h-full max-h-[calc(100vh-120px)]">
            
            <!-- æ ‡é¢˜åŒº -->
            <div class="p-6 pb-2">
                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-3">
                    <span class="w-1.5 h-6 bg-brand-600 rounded-full"></span>
                    æ•°æ®æ–‡ä»¶è½½å…¥
                </h2>
            </div>

            <!-- æ‹–æ‹½ä¸Šä¼ åŒº -->
            <div class="flex-1 px-6 py-4 flex flex-col min-h-0">
                <div id="dropArea" class="flex-1 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50 bg-dot-pattern relative group transition-all duration-300 hover:border-brand-400 hover:bg-brand-50/30 overflow-hidden flex flex-col">
                    
                    <!-- æ–‡ä»¶åæµ®å±‚ -->
                    <div id="fileNameDisplay" class="absolute top-3 left-3 right-3 text-center bg-white/90 backdrop-blur-sm shadow-sm py-1.5 px-3 rounded-lg text-xs font-semibold text-slate-600 truncate border border-slate-100 z-10 hidden">
                        filename.pdf
                    </div>

                    <!-- é¢„è§ˆå®¹å™¨ -->
                    <div class="flex-1 flex items-center justify-center overflow-hidden p-2 relative">
                        <span id="placeholder" class="text-slate-400 text-center pointer-events-none p-6">
                            <div class="mb-3 text-4xl opacity-30 mx-auto w-16 h-16 flex items-center justify-center">
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>
                            </div>
                            <p class="text-sm font-semibold text-slate-600 mb-1">ç‚¹å‡»ä¸Šä¼  æˆ– æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                            <p class="text-[10px] text-slate-400">æ”¯æŒ PDF / PNG / JPG (æ”¯æŒæ‰¹é‡é€‰æ‹©)</p>
                        </span>
                        
                        <div class="preview-container w-full h-full">
                            <img id="previewImg" class="rounded shadow-sm">
                            <canvas id="canvasOverlay"></canvas>
                        </div>
                    </div>
                </div>
                <input type="file" id="fileInput" accept="image/*,application/pdf" multiple class="hidden">
            </div>

            <!-- æ§åˆ¶æŒ‰é’®ç»„ -->
            <div class="p-6 pt-2 space-y-3 bg-white border-t border-slate-100 z-10">
                <button id="uploadBtn" class="w-full py-2.5 rounded-lg border border-slate-200 text-slate-600 text-sm font-semibold hover:bg-slate-50 transition flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                    é€‰æ‹©æœ¬åœ°æ–‡ä»¶
                </button>

                <div class="grid grid-cols-2 gap-3">
                    <button id="startBtn" onclick="startProcessing()" disabled class="col-span-1 bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all py-3 rounded-lg text-sm font-bold shadow-lg shadow-slate-200 flex items-center justify-center gap-2">
                        <span>â–¶ï¸</span> å¼€å§‹æ·±åº¦è¯†åˆ«
                    </button>
                    <button id="stopBtn" onclick="stopTask()" disabled class="col-span-1 bg-white border border-rose-100 text-rose-500 hover:bg-rose-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all py-3 rounded-lg text-sm font-bold flex items-center justify-center">
                        åœæ­¢
                    </button>
                </div>

                <button onclick="clearAll()" class="w-full text-xs text-slate-400 hover:text-slate-600 flex items-center justify-center gap-1 py-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg>
                    æ¸…ç©ºé‡ç½®é¡µé¢å†…å®¹
                </button>
            </div>
        </aside>

        <!-- å³ä¾§æ : ç»“æœå±•ç¤º -->
        <div class="col-span-12 lg:col-span-8 xl:col-span-9 flex flex-col gap-6 h-full min-h-0 overflow-y-auto pr-1 pb-1">
            
            <!-- 1. ç»Ÿè®¡å¡ç‰‡åŒº -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 shrink-0">
                <!-- è“è‰²å¡ç‰‡ -->
                <div class="bg-brand-600 rounded-2xl p-5 text-white shadow-lg shadow-brand-500/20 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4 group-hover:scale-110 transition-transform duration-500">
                        <svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor"><path d="M4 7c0-1.1.9-2 2-2h2.5a.5.5 0 0 1 0 1H6a1 1 0 0 0-1 1v2.5a.5.5 0 0 1-1 0V7zm0 10v-2.5a.5.5 0 0 1 1 0V17a1 1 0 0 0 1 1h2.5a.5.5 0 0 1 0 1H6a2 2 0 0 1-2-2zm10 2.5a.5.5 0 0 1 0-1H18a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0V17a2 2 0 0 1-2 2h-4.5zM19 9.5v-2.5a1 1 0 0 0-1-1h-2.5a.5.5 0 0 1 0-1H18a2 2 0 0 1 2 2v2.5a.5.5 0 0 1-1 0z"/></svg>
                    </div>
                    <p class="text-brand-100 text-xs font-semibold uppercase tracking-wider mb-1">æ¡ç è¯†åˆ«ç»“æœ</p>
                    <div class="flex items-baseline gap-2">
                        <span id="barcodeCountBadgeDisplay" class="text-4xl font-bold tracking-tight">0</span>
                        <span class="text-sm text-brand-200 font-medium italic">Items Detected</span>
                    </div>
                </div>

                <!-- ç™½è‰²å¡ç‰‡ -->
                <div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm relative overflow-hidden">
                    <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">å¤„ç†é¡µæ•°</p>
                    <div class="flex items-baseline gap-2">
                        <span id="pageCountDisplay" class="text-4xl font-bold text-slate-800 tracking-tight">0</span>
                        <span class="text-sm text-slate-400 font-medium italic">Pages</span>
                    </div>
                     <!-- éšè—çš„çœŸå® Badge å¼•ç”¨ï¼Œç”¨äºJSæ›´æ–° -->
                    <span id="barcodeCountBadge" class="hidden">0</span>
                </div>
            </div>

            <!-- 2. è¿›åº¦æ¡ -->
            <div id="progressSection" class="hidden bg-white border border-slate-100 px-4 py-3 rounded-xl flex items-center gap-3 shadow-sm animate-fade-in">
                <div id="progressIconContainer" class="w-6 h-6 rounded-full flex items-center justify-center text-brand-600">
                    <svg class="animate-spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                </div>
                <div class="flex-1 flex justify-between items-center">
                    <span id="mainStatusText" class="text-sm font-semibold text-slate-700">å‡†å¤‡å°±ç»ª</span>
                    <span id="subStatusText" class="text-xs text-slate-400">ç­‰å¾…æ“ä½œ</span>
                </div>
                <div id="pageBadge" class="text-xs font-mono bg-slate-100 px-2 py-0.5 rounded text-slate-600 hidden">0/0</div>
            </div>

            <!-- 3. ç»“æœå†…å®¹åŒº -->
            <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                
                <!-- æ¡ç æ˜ç»† -->
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col overflow-hidden h-full">
                    <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0">
                        <h3 class="font-bold text-brand-600 text-sm flex items-center gap-2">
                            æ¡ç æ˜ç»† - æå–åŒº
                            <span class="text-[10px] text-brand-600 font-bold px-2 py-0.5 bg-brand-50 rounded-full border border-brand-100">
                                å…± <span id="barcodeDetailCount">0</span> æ¡
                            </span>
                        </h3>
                        <button onclick="copyResults('resultArea')" class="text-slate-400 hover:text-brand-600 transition p-1" title="å¤åˆ¶">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                        </button>
                    </div>
                    <textarea id="resultArea" placeholder="è¯†åˆ«å‡ºçš„æ¡ç æ•°å€¼..." 
                        class="flex-1 w-full p-5 resize-none outline-none text-sm font-mono text-slate-600 leading-relaxed placeholder-slate-300 bg-transparent"></textarea>
                </div>

                <!-- AI ç‰¹å¾ä¿¡æ¯ -->
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col overflow-hidden h-full">
                    <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0">
                        <h3 class="font-bold text-slate-500 text-sm flex items-center gap-2">
                            æ–‡æœ¬æå–ä¿¡æ¯ (OCR)
                        </h3>
                        <div class="flex items-center gap-2">
                            <span class="text-[10px] bg-slate-50 text-slate-400 px-2 py-0.5 rounded-full border border-slate-100">ä»…å¥‡æ•°é¡µ</span>
                            <button onclick="copyResults('ocrResultArea')" class="text-slate-400 hover:text-brand-600 transition p-1" title="å¤åˆ¶">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>
                            </button>
                        </div>
                    </div>
                    <textarea id="ocrResultArea" placeholder="AI æå–çš„ç‰¹å¾æ–‡æœ¬..." 
                        class="flex-1 w-full p-5 resize-none outline-none text-sm font-mono text-slate-600 leading-relaxed placeholder-slate-300 bg-transparent"></textarea>
                </div>
            </div>
        </div>
    </main>
    
    <canvas id="canvasHidden"></canvas>

    <!-- æ¶ˆæ¯æ¡† -->
    <div id="messageBox" class="fixed inset-0 bg-slate-900/40 backdrop-blur-[2px] hidden items-center justify-center z-50 animate-fade-in">
        <div class="bg-white p-6 rounded-2xl shadow-2xl border border-slate-100 max-w-sm w-full transform transition-all scale-100">
            <h3 id="messageTitle" class="text-lg font-bold mb-2 text-slate-800 flex items-center gap-2">æç¤º</h3>
            <p id="messageContent" class="text-slate-500 mb-6 text-sm leading-relaxed"></p>
            <button onclick="closeMessageBox()" class="w-full bg-brand-600 text-white py-2.5 rounded-xl font-medium hover:bg-brand-700 transition duration-150 shadow-lg shadow-brand-500/20">ç¡®å®š</button>
        </div>
    </div>

    <!-- API è®¾ç½® æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-[2px] hidden items-center justify-center z-50 animate-fade-in">
        <div class="bg-white p-8 rounded-2xl shadow-2xl border border-slate-100 max-w-md w-full transform transition-all scale-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">
                    âš™ï¸ API é…ç½®
                </h3>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="mb-6">
                <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-2">Qwen API Key (DashScope)</label>
                <div class="relative">
                    <input type="password" id="apiKeyInput" placeholder="sk-..." 
                        class="w-full bg-slate-50 border border-slate-200 rounded-xl px-4 py-3 text-sm focus:ring-2 focus:ring-brand-500/20 focus:border-brand-500 outline-none transition-all text-slate-700 pr-10">
                    <button onclick="clearApiKey()" class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 hover:text-rose-500 transition p-1" title="æ¸…ç©º Key">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
                    </button>
                </div>
                <p class="text-xs text-slate-400 mt-2 leading-relaxed">
                    Key ä»…ä¿å­˜åœ¨æœ¬åœ°æµè§ˆå™¨ä¸­ï¼Œç”¨äºè°ƒç”¨é˜¿é‡Œäº‘é€šä¹‰åƒé—®è§†è§‰æ¨¡å‹ã€‚
                </p>
            </div>
            <div class="flex gap-3 justify-end">
                <button onclick="toggleSettings()" class="px-5 py-2.5 rounded-xl text-sm font-medium text-slate-500 hover:bg-slate-50 transition">å–æ¶ˆ</button>
                <button onclick="saveSettings()" class="px-5 py-2.5 bg-brand-600 hover:bg-brand-700 text-white rounded-xl text-sm font-medium shadow-lg shadow-brand-500/20 transition">ä¿å­˜é…ç½®</button>
            </div>
        </div>
    </div>

<script>
    // --- 1. å…¨å±€å˜é‡ä¸ UI å¼•ç”¨ ---
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const startBtn = document.getElementById('startBtn'); 
    const stopBtn = document.getElementById('stopBtn');
    const previewImg = document.getElementById('previewImg');
    const resultArea = document.getElementById('resultArea');
    const ocrResultArea = document.getElementById('ocrResultArea'); 
    const dropArea = document.getElementById('dropArea');
    const placeholder = document.getElementById('placeholder');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const barcodeCountBadge = document.getElementById('barcodeCountBadge'); // é€»è¾‘å¼•ç”¨
    const barcodeCountBadgeDisplay = document.getElementById('barcodeCountBadgeDisplay'); // è§†è§‰å¼•ç”¨
    const pageCountDisplay = document.getElementById('pageCountDisplay'); // é¡µé¢è®¡æ•°è§†è§‰å¼•ç”¨
    
    // è¿›åº¦æ¡ç›¸å…³å¼•ç”¨
    const progressSection = document.getElementById('progressSection');
    const progressIconContainer = document.getElementById('progressIconContainer');
    const mainStatusText = document.getElementById('mainStatusText');
    const subStatusText = document.getElementById('subStatusText');
    const pageBadge = document.getElementById('pageBadge');
    
    const canvasHidden = document.getElementById('canvasHidden');
    const ctxHidden = canvasHidden.getContext('2d', { willReadFrequently: true });
    const canvasOverlay = document.getElementById('canvasOverlay');
    const ctxOverlay = canvasOverlay.getContext('2d');

    const messageBox = document.getElementById('messageBox');
    const messageTitle = document.getElementById('messageTitle');
    const messageContent = document.getElementById('messageContent');
    
    const settingsModal = document.getElementById('settingsModal');
    const apiKeyInput = document.getElementById('apiKeyInput');

    let fileQueue = [];
    let shouldStop = false; 

    // --- 2. API é…ç½®ä¸å·¥å…·å‡½æ•° ---
    
    let QWEN_API_KEY = localStorage.getItem('QWEN_API_KEY') || "";

    function updateApiStatus() {
        const indicator = document.getElementById('apiStatusIndicator');
        const dot = document.getElementById('apiStatusDot');
        const text = document.getElementById('apiStatusText');
        
        if (QWEN_API_KEY && QWEN_API_KEY.trim() !== "") {
            indicator.className = "flex items-center gap-2 px-4 py-1.5 bg-emerald-50 text-emerald-600 rounded-full text-xs font-bold tracking-wide cursor-pointer transition-colors border border-emerald-100 hover:bg-emerald-100";
            dot.className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
            text.innerText = "API READY";
        } else {
            indicator.className = "flex items-center gap-2 px-4 py-1.5 bg-slate-100 text-slate-500 rounded-full text-xs font-bold tracking-wide cursor-pointer transition-colors border border-transparent hover:bg-slate-200";
            dot.className = "w-2 h-2 rounded-full bg-slate-400";
            text.innerText = "NO API KEY";
        }
    }

    updateApiStatus();

    function toggleSettings() {
        if (settingsModal.classList.contains('hidden')) {
            apiKeyInput.value = QWEN_API_KEY;
            settingsModal.classList.remove('hidden');
            settingsModal.classList.add('flex');
        } else {
            settingsModal.classList.remove('flex');
            settingsModal.classList.add('hidden');
        }
    }

    function clearApiKey() {
        apiKeyInput.value = "";
        apiKeyInput.focus();
    }

    function saveSettings() {
        const key = apiKeyInput.value.trim();
        if (!key) {
            QWEN_API_KEY = "";
            localStorage.removeItem('QWEN_API_KEY');
            toggleSettings();
            updateApiStatus();
            showMessageBox("é…ç½®å·²æ›´æ–°", "API Key å·²æ¸…ç©º", "success");
            return;
        }
        QWEN_API_KEY = key;
        localStorage.setItem('QWEN_API_KEY', key);
        toggleSettings();
        updateApiStatus(); 
        showMessageBox("è®¾ç½®æˆåŠŸ", "API Key å·²ä¿å­˜", "success");
    }

    function showMessageBox(title, content, type = 'error') {
        messageTitle.innerText = title;
        messageContent.innerText = content;
        if(type === 'error') {
            messageTitle.className = "text-lg font-bold mb-2 text-rose-600 flex items-center gap-2";
        } else {
            messageTitle.className = "text-lg font-bold mb-2 text-brand-600 flex items-center gap-2";
        }
        messageBox.classList.remove('hidden');
        messageBox.classList.add('flex');
    }

    function closeMessageBox() {
        messageBox.classList.remove('flex');
        messageBox.classList.add('hidden');
    }

    function updateBarcodeCount() {
        const val = resultArea.value;
        const lines = val.split('\n');
        const count = lines.filter(line => line.trim() !== '' && !line.trim().startsWith('ã€')).length;
        
        barcodeCountBadge.innerText = count;
        barcodeCountBadgeDisplay.innerText = count; 
        
        const detailCountSpan = document.getElementById('barcodeDetailCount');
        if (detailCountSpan) {
            detailCountSpan.innerText = count;
        }
    }

    function updateProgress(mainText, subText = "", pageInfo = null, statusType = 'loading') {
        progressSection.classList.remove('hidden');
        mainStatusText.innerText = mainText;
        if (subText) subStatusText.innerText = subText;
        
        if (pageInfo) {
            pageBadge.classList.remove('hidden');
            pageBadge.innerText = `${pageInfo.current} / ${pageInfo.total}`;
            if (pageInfo.total > 0) {
            }
        } else {
            pageBadge.classList.add('hidden');
        }

        progressIconContainer.className = "w-6 h-6 rounded-full flex items-center justify-center"; 
        
        let svgContent = '';
        
        switch(statusType) {
            case 'loading':
                progressIconContainer.classList.add('text-brand-600');
                svgContent = `<svg class="animate-spin" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>`;
                break;
            case 'success':
                progressIconContainer.classList.add('text-emerald-500');
                svgContent = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`;
                break;
            case 'stopped':
            case 'error':
                progressIconContainer.classList.add('text-rose-500');
                svgContent = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="6" y="6" width="12" height="12" rx="1"></rect></svg>`;
                break;
            case 'idle':
            default:
                progressIconContainer.classList.add('text-slate-400');
                svgContent = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`;
                break;
        }
        
        progressIconContainer.innerHTML = svgContent;
    }

    // --- 3. æ ¸å¿ƒ API è°ƒç”¨é€»è¾‘ (Qwen-MAX) ---

    async function fetchWithRetry(url, options, retries = 1) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 20000); 

        const config = { ...options, signal: controller.signal };

        try {
            const response = await fetch(url, config);
            clearTimeout(timeoutId);

            if (!response.ok) {
                if (response.status === 429 || response.status >= 500) {
                    throw new Error(`HTTP Error ${response.status}`);
                }
                const errData = await response.json();
                throw new Error(errData.message || `è¯·æ±‚å¤±è´¥ (${response.status})`);
            }
            return response;
        } catch (err) {
            clearTimeout(timeoutId);
            if (err.name === 'AbortError') throw new Error("API è¯·æ±‚è¶…æ—¶");
            if (retries > 0) {
                await new Promise(r => setTimeout(r, 1000)); 
                return fetchWithRetry(url, options, retries - 1);
            }
            throw err;
        }
    }

    async function runOCR(base64Image) {
        if (!QWEN_API_KEY) throw new Error("æœªé…ç½® API Key");

        const apiUrl = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions";
        const sysPrompt = "è¯·è¯†åˆ«å›¾ç‰‡æ–‡å­—ã€‚è¦æ±‚ï¼š1.ä¸¥æ ¼æŒ‰ä»ä¸Šåˆ°ä¸‹ã€ä»å·¦åˆ°å³çš„è§†è§‰é¡ºåºã€‚2.ä¸éœ€è¦è¯†åˆ«ä¸”è¾“å‡ºå¸¦æœ‰â€œå‰åå°ºç ä¸åŒï¼Œè¯·ä¸è¦è´´é”™â€å’Œå›¾ç‰‡å·¦è¾¹çš„æ–‡å­—å†…å®¹ã€‚3.è€Œä¸”åªè¦è¯†åˆ«å›¾ç‰‡å³ä¸‹æ–¹æ–‡å­—å†…å®¹ã€‚ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œæ— æè¿°ã€‚";

        const payload = {
            model: "qwen-vl-max", 
            messages: [
                {
                    role: "user",
                    content: [
                        { type: "text", text: sysPrompt },
                        { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64Image}` } }
                    ]
                }
            ],
            max_tokens: 2000
        };

        try {
            const response = await fetchWithRetry(apiUrl, {
                method: "POST",
                headers: {
                    "Authorization": `Bearer ${QWEN_API_KEY}`,
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(payload)
            });
            const data = await response.json();
            if (data.choices && data.choices.length > 0) {
                return data.choices[0].message.content.trim();
            }
            return "";
        } catch (error) {
            console.error("OCR API Error:", error);
            throw error; 
        }
    }

    // --- 4. å›¾åƒå¤„ç†ä¸ä¸šåŠ¡é€»è¾‘ ---

    function enhanceImage(imageData) {
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) {
            const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2];
            data[i] = data[i + 1] = data[i + 2] = gray;
        }
        return imageData;
    }

    function drawBoundingBox(results) {
        ctxOverlay.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
        const validResults = results.filter(r => r && r.box);
        if (validResults.length === 0) return;
        const uniqueCodes = new Set();
        
        validResults.forEach((result, index) => {
            const code = result.codeResult.code;
            if (uniqueCodes.has(code)) return;
            uniqueCodes.add(code);
            const box = result.box;
            if (!box || box.length < 4) return;
            ctxOverlay.strokeStyle = index === 0 ? '#10b981' : '#f59e0b'; 
            ctxOverlay.lineWidth = 3;
            const x = Math.floor(box[0]);
            const y = Math.floor(box[1]);
            const w = Math.floor(box[2] - box[0]);
            const h = Math.floor(box[3] - box[1]);
            if (w > 0 && h > 0) ctxOverlay.strokeRect(x, y, w, h);
        });
    }

    // --- æ ¸å¿ƒå¤„ç†å‡½æ•° (å•é¡µå¤„ç†) ---
    async function processImage(src, pdfInfo = null) {
        if (shouldStop) return; 

        // UI Update
        previewImg.src = src;
        previewImg.style.display = 'block';
        
        if (pdfInfo) {
            updateProgress(`æ­£åœ¨å¤„ç†ç¬¬ ${pdfInfo.index} é¡µ`, "è§£æå›¾åƒæ•°æ®ä¸è¯†åˆ«æ¡ç ...", { current: pdfInfo.index, total: pdfInfo.total }, 'loading');
        } else {
            updateProgress("æ­£åœ¨è¯†åˆ«", "å›¾åƒåˆ†æä¸­...", null, 'loading');
        }

        ctxOverlay.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
        
        await new Promise((resolve, reject) => {
            if (previewImg.complete) resolve();
            else {
                previewImg.onload = resolve;
                previewImg.onerror = () => reject(new Error("Image Load Failed"));
            }
        });

        if (shouldStop) return; 

        const imgObj = previewImg;
        const MAX_WIDTH = 1600; 
        let width = imgObj.naturalWidth;
        let height = imgObj.naturalHeight;
        
        if (width > MAX_WIDTH) {
            height *= MAX_WIDTH / width;
            width = MAX_WIDTH;
        }
        width = Math.floor(width);
        height = Math.floor(height);
        
        if (width === 0 || height === 0) return;

        canvasHidden.width = canvasOverlay.width = width;
        canvasHidden.height = canvasOverlay.height = height;
        
        ctxHidden.fillStyle = "white";
        ctxHidden.fillRect(0, 0, width, height);
        ctxHidden.drawImage(imgObj, 0, 0, width, height);
        
        let fullImageData = ctxHidden.getImageData(0, 0, width, height);
        fullImageData = enhanceImage(fullImageData);
        ctxHidden.putImageData(fullImageData, 0, 0);

        // 1. æ¡ç è¯†åˆ«
        const SEGMENT_HEIGHT = 400; 
        const step = 250; 
        
        let allResults = [];
        const uniqueCodesSet = new Set(); 
        
        const decoderConfig = {
            numOfWorkers: 0,
            inputStream: { size: width },
            decoder: {
                readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "i2of5_reader", "upc_reader"],
                multiple: true
            },
            locate: true, 
            patchSize: "medium", 
            halfSample: false 
        };

        for (let startY = 0; startY < height; startY += step) {
            if (shouldStop) break; 

            const segmentH = Math.min(SEGMENT_HEIGHT, height - startY);
            if (segmentH <= 0) break;

            const segmentCanvas = document.createElement('canvas');
            segmentCanvas.width = width;
            segmentCanvas.height = segmentH;
            const segmentCtx = segmentCanvas.getContext('2d');
            const segmentImageData = ctxHidden.getImageData(0, startY, width, segmentH);
            segmentCtx.putImageData(segmentImageData, 0, 0);

            decoderConfig.src = segmentCanvas.toDataURL('image/jpeg', 0.85);
            
            await new Promise(resolve => {
                const qTimer = setTimeout(resolve, 3000); 
                try {
                    Quagga.decodeSingle(decoderConfig, function(results) {
                        clearTimeout(qTimer);
                        if (results && results.length > 0) {
                            results.forEach(r => {
                                if(r.codeResult) {
                                    const code = r.codeResult.code;
                                    if (!uniqueCodesSet.has(code)) {
                                        uniqueCodesSet.add(code);
                                        if (r.box) {
                                            r.box[1] = (r.box[1] || 0) + startY;
                                            r.box[3] = (r.box[3] || 0) + startY;
                                        }
                                        allResults.push(r);
                                    }
                                }
                            });
                        }
                        resolve();
                    });
                } catch (e) { clearTimeout(qTimer); resolve(); }
            });
            
            if (startY + step >= height && startY < height) break;
        }

        drawBoundingBox(allResults);

        // æ¡ç è¾“å‡º
        if (allResults.length > 0) {
            let currentVal = resultArea.value;
            if (currentVal.length > 0 && !currentVal.endsWith('\n')) {
                resultArea.value += '\n';
            }
            allResults.forEach(result => {
                resultArea.value += `${result.codeResult.code}\n`; 
            });
            resultArea.scrollTop = resultArea.scrollHeight;
            updateBarcodeCount(); 
        }

        if (shouldStop) return; 

        // 2. å…¨æ–‡ OCR
        const isOddPage = !pdfInfo || (pdfInfo.index % 2 !== 0);

        if (isOddPage) {
            if (pdfInfo) {
                 updateProgress(`æ­£åœ¨å¤„ç†ç¬¬ ${pdfInfo.index} é¡µ`, "AI è¯­ä¹‰åˆ†æä¸­...", { current: pdfInfo.index, total: pdfInfo.total }, 'loading');
            } else {
                 updateProgress("æ­£åœ¨è¯†åˆ«", "AI è¯­ä¹‰åˆ†æä¸­...", null, 'loading');
            }

            const fullPageBase64 = canvasHidden.toDataURL('image/jpeg', 0.6).split(',')[1];
            
            if (QWEN_API_KEY) {
                try {
                    let ocrText = await runOCR(fullPageBase64);
                    if (shouldStop) return; 

                    // ä¿®æ”¹ï¼šOCRç»“æœå¤„ç† - æ¸…æ´—ç©ºè¡Œ
                    // å°†æ‰€æœ‰æ¢è¡Œç¬¦æ ‡å‡†åŒ–ä¸º\nï¼Œç„¶åè¿‡æ»¤æ‰ç©ºè¡Œ
                    ocrText = ocrText.replace(/(\r\n|\n|\r)/gm, "\n");
                    ocrText = ocrText.split('\n').filter(line => line.trim() !== '').join('\n');

                    // ä¿®æ”¹ï¼šæ™ºèƒ½æ‹¼æ¥ï¼Œé˜²æ­¢æ ‡å¤´åå‡ºç°åŒé‡æ¢è¡Œ
                    if (ocrText.length > 0) {
                        // å¦‚æœå½“å‰æ–‡æœ¬åŒºä¸ä¸ºç©ºä¸”ä¸ä»¥æ¢è¡Œç¬¦ç»“å°¾ï¼Œåˆ™æ·»åŠ æ¢è¡Œç¬¦
                        if (ocrResultArea.value.length > 0 && !ocrResultArea.value.endsWith('\n')) {
                            ocrResultArea.value += '\n';
                        }
                        ocrResultArea.value += ocrText;
                        ocrResultArea.scrollTop = ocrResultArea.scrollHeight;
                    }

                } catch (e) {
                    console.warn("OCR Failed internally:", e);
                }
            }
        } else {
            if (pdfInfo) {
                console.log(`Skipping OCR for even page: ${pdfInfo.index}`);
            }
        }
    }

    // --- PDF å¤„ç†å‡½æ•° ---
    async function processPdfFile(file) {
        updateProgress("åˆå§‹åŒ– PDF", "è¯»å–æ–‡ä»¶ç»“æ„...", null, 'loading');
        
        try {
            const arrayBuffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            
            if (pdf.numPages === 0) throw new Error("PDF ä¸ºç©º");
            
            for (let i = 1; i <= pdf.numPages; i++) {
                if (shouldStop) break; 

                await new Promise(resolve => setTimeout(resolve, 50)); 

                updateProgress(`æ¸²æŸ“ç¬¬ ${i} é¡µ`, "å‡†å¤‡å›¾åƒæ•°æ®...", { current: i, total: pdf.numPages }, 'loading');
                
                try {
                    const page = await pdf.getPage(i);
                    const viewport = page.getViewport({ scale: 2.0 }); 

                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7); 
                    
                    if (shouldStop) break; 

                    await Promise.race([
                        processImage(dataUrl, { index: i, total: pdf.numPages }),
                        new Promise((resolve) => setTimeout(() => {
                            if (!shouldStop) console.warn(`Page ${i} Timeout - Force Skipping`);
                            resolve(); 
                        }, 20000))
                    ]);
                    
                    canvas.width = 1; canvas.height = 1; 

                } catch (pageError) {
                    console.error(`Page ${i} Error:`, pageError);
                }
            }

        } catch (error) {
            console.error(error);
            showMessageBox("PDF é”™è¯¯", error.message, "error");
            throw error; 
        }
    }

    // --- åœæ­¢åŠŸèƒ½ ---
    function stopTask() {
        if (!shouldStop) {
            shouldStop = true;
            updateProgress("æ­£åœ¨åœæ­¢...", "ç­‰å¾…å½“å‰æ“ä½œç»“æŸ", null, 'stopped');
            stopBtn.disabled = true; 
        }
    }

    // --- äº‹ä»¶ç›‘å¬ä¸æµç¨‹æ§åˆ¶ ---

    function handleFilesSelect(files) {
        if (!files || files.length === 0) return;
        
        const validFiles = Array.from(files).filter(file => 
            file.type === 'application/pdf' || file.type.startsWith('image/')
        );

        if (validFiles.length === 0) {
            showMessageBox("æ ¼å¼é”™è¯¯", "æ²¡æœ‰æ‰¾åˆ°æ”¯æŒçš„æ–‡ä»¶æ ¼å¼ (PDF/å›¾ç‰‡)ã€‚", "error");
            return;
        }

        fileQueue = validFiles;
        shouldStop = false;
        
        placeholder.style.display = 'none';
        fileNameDisplay.classList.remove('hidden');
        
        if (validFiles.length > 1) {
            fileNameDisplay.innerText = `å·²å°±ç»ª ${validFiles.length} ä¸ªæ–‡ä»¶`;
            previewImg.style.display = 'none';
            placeholder.style.display = 'block';
            placeholder.innerHTML = `
                <div class="mb-2 text-4xl">ğŸ“š</div>
                <div class="text-sm text-slate-500 font-bold mt-2">æ‰¹é‡ä»»åŠ¡å·²å°±ç»ª</div>
                <div class="text-xs text-slate-400 mt-1">å…± ${validFiles.length} ä¸ªæ–‡ä»¶ç­‰å¾…å¤„ç†</div>
            `;
        } else {
            const file = validFiles[0];
            fileNameDisplay.innerText = file.name;
            if (file.type === 'application/pdf') {
                previewImg.style.display = 'none';
                placeholder.style.display = 'block';
                placeholder.innerHTML = `
                    <div class="mb-2 text-4xl">ğŸ“„</div>
                    <div class="text-sm text-slate-500 font-bold mt-2">PDF æ–‡æ¡£å·²å°±ç»ª</div>
                    <div class="text-xs text-slate-400 mt-1">${file.name}</div>
                `;
            } else {
                const reader = new FileReader();
                reader.onload = e => {
                    previewImg.src = e.target.result;
                    previewImg.style.display = 'block';
                };
                reader.readAsDataURL(file);
            }
        }

        resultArea.value = '';
        ocrResultArea.value = '';
        updateBarcodeCount(); // é‡ç½®è®¡æ•°
        pageCountDisplay.innerText = "0"; // é‡ç½®é¡µæ•°
        ctxOverlay.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
        
        updateProgress("æ–‡ä»¶å°±ç»ª", `ç­‰å¾…å¤„ç† ${validFiles.length} ä¸ªæ–‡ä»¶`, null, 'idle');
        
        startBtn.disabled = false;
        stopBtn.disabled = true; 
        startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    // è¾…åŠ©å‡½æ•°ï¼šæ·»åŠ æ–‡ä»¶åæ ‡å¤´åˆ°ç»“æœåŒº
    function appendFileHeader(filename) {
        // æ¡ç åŒºæ ‡å¤´ - ä¿®æ”¹ï¼šå»é™¤é¢å¤–ç©ºè¡Œï¼Œä»…ç¡®ä¿æ¢è¡Œ
        if (resultArea.value.length > 0 && !resultArea.value.endsWith('\n')) {
            resultArea.value += '\n';
        }
        // åˆ é™¤ä¹‹å‰è¿™é‡Œå­˜åœ¨çš„é¢å¤–æ¢è¡Œç¬¦é€»è¾‘
        resultArea.value += `ã€${filename}ã€‘\n`;
        resultArea.scrollTop = resultArea.scrollHeight;

        // OCRåŒºæ ‡å¤´ - ä¿®æ”¹ï¼šå»é™¤é¢å¤–ç©ºè¡Œ
        if (ocrResultArea.value.length > 0 && !ocrResultArea.value.endsWith('\n')) {
            ocrResultArea.value += '\n';
        }
        // åˆ é™¤ä¹‹å‰è¿™é‡Œå­˜åœ¨çš„é¢å¤–æ¢è¡Œç¬¦é€»è¾‘
        ocrResultArea.value += `ã€${filename}ã€‘\n`;
        ocrResultArea.scrollTop = ocrResultArea.scrollHeight;
    }

    async function startProcessing() {
        if (!fileQueue || fileQueue.length === 0) return;

        if (!QWEN_API_KEY || QWEN_API_KEY.trim() === "") {
            const userWantsToSet = confirm("âš ï¸ æ£€æµ‹åˆ°æ‚¨å°šæœªé…ç½® API Keyã€‚\n\nâ€¢ å¦‚æœæ‚¨éœ€è¦ä½¿ç”¨ã€ŒAI æ–‡å­—è¯†åˆ«ã€åŠŸèƒ½ï¼Œè¯·ç‚¹å‡»ã€ç¡®å®šã€‘å‰å¾€è®¾ç½®ã€‚\nâ€¢ å¦‚æœæ‚¨ä»…éœ€ä½¿ç”¨ã€Œæ¡ç æ‰«æã€åŠŸèƒ½ï¼Œè¯·ç‚¹å‡»ã€å–æ¶ˆã€‘ç›´æ¥å¼€å§‹ã€‚");
            if (userWantsToSet) {
                toggleSettings();
                return; 
            }
        }

        startBtn.disabled = true;
        stopBtn.disabled = false; 
        startBtn.innerHTML = "â³ å¤„ç†ä¸­...";
        startBtn.classList.add('opacity-70', 'cursor-wait');
        shouldStop = false;
        
        resultArea.value = '';
        ocrResultArea.value = '';
        updateBarcodeCount(); 
        pageCountDisplay.innerText = "0";
        
        for (let i = 0; i < fileQueue.length; i++) {
            if (shouldStop) break;

            const currentFile = fileQueue[i];
            
            fileNameDisplay.innerText = `æ­£åœ¨å¤„ç† (${i+1}/${fileQueue.length}): ${currentFile.name}`;
            updateProgress(`æ­£åœ¨å¤„ç†æ–‡ä»¶ ${i+1}/${fileQueue.length}`, currentFile.name, null, 'loading');

            appendFileHeader(currentFile.name);

            try {
                if (currentFile.type === 'application/pdf') {
                    await processPdfFile(currentFile);
                } else {
                    await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = async (e) => {
                            try {
                                await Promise.race([
                                    processImage(e.target.result),
                                    new Promise(r => setTimeout(r, 20000))
                                ]);
                                resolve();
                            } catch (err) { reject(err); }
                        };
                        reader.onerror = reject;
                        reader.readAsDataURL(currentFile);
                    });
                }
            } catch (err) {
                console.error(`Error processing file ${currentFile.name}:`, err);
            }
        }
        
        if (shouldStop) {
            updateProgress("å·²åœæ­¢", "ç”¨æˆ·ç»ˆæ­¢æ“ä½œ", null, 'stopped');
        } else {
            updateProgress("å…¨éƒ¨å®Œæˆ", `å·²å¤„ç† ${fileQueue.length} ä¸ªæ–‡ä»¶`, null, 'success');
            fileNameDisplay.innerText = `å¤„ç†å®Œæˆ: å…± ${fileQueue.length} ä¸ªæ–‡ä»¶`;
        }
        
        startBtn.disabled = false;
        stopBtn.disabled = true;
        startBtn.innerHTML = "<span>â–¶ï¸</span> å¼€å§‹æ·±åº¦è¯†åˆ«";
        startBtn.classList.remove('opacity-70', 'cursor-wait');
        shouldStop = false;
    }

    uploadBtn.addEventListener('click', () => fileInput.click());
    
    fileInput.addEventListener('change', e => {
        if(e.target.files && e.target.files.length > 0) handleFilesSelect(e.target.files);
        fileInput.value = '';
    });

    document.addEventListener('paste', e => {
        const items = e.clipboardData.items;
        const files = [];
        for (let item of items) {
            if (item.type.indexOf('image') !== -1) {
                files.push(item.getAsFile());
            }
        }
        if (files.length > 0) {
            handleFilesSelect(files);
            e.preventDefault(); 
        }
    });

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
        document.body.addEventListener(eventName, e => {
            if (e.target.id === 'dropArea') {
                if (eventName === 'dragenter' || eventName === 'dragover') {
                    dropArea.classList.add('border-brand-400', 'bg-brand-50');
                } else {
                    dropArea.classList.remove('border-brand-400', 'bg-brand-50');
                }
            } else {
                dropArea.classList.remove('border-brand-400', 'bg-brand-50');
            }
        }, false);
    });

    dropArea.addEventListener('drop', e => {
        const dt = e.dataTransfer;
        const files = dt.files;
        if (files.length > 0) {
            handleFilesSelect(files);
        }
    }, false);

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    function clearAll() {
        fileQueue = []; // æ¸…ç©ºé˜Ÿåˆ—
        resultArea.value = '';
        ocrResultArea.value = '';
        updateBarcodeCount(); 
        pageCountDisplay.innerText = "0";
        previewImg.src = '';
        previewImg.style.display = 'none';
        placeholder.style.display = 'block';
        placeholder.innerHTML = `
            <div class="mb-3 text-4xl opacity-30 mx-auto w-16 h-16 flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>
            </div>
            <p class="text-sm font-semibold text-slate-600 mb-1">ç‚¹å‡»ä¸Šä¼  æˆ– æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</p>
            <p class="text-[10px] text-slate-400">æ”¯æŒ PDF / PNG / JPG (æ”¯æŒæ‰¹é‡é€‰æ‹©)</p>
        `;
        fileNameDisplay.classList.add('hidden');
        ctxOverlay.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
        progressSection.classList.add('hidden');
        
        startBtn.disabled = true;
        stopBtn.disabled = true;
        startBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
    
    function copyResults(areaId) {
        const textarea = document.getElementById(areaId);
        if (textarea && textarea.value) {
            textarea.select();
            document.execCommand('copy');
            showMessageBox("å¤åˆ¶æˆåŠŸ", "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "success");
        } else {
            showMessageBox("æç¤º", "æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹", "primary");
        }
    }
</script>

</body>
</html>
