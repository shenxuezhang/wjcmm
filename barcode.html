<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDFæ¡ç å·¥ä½œå° SmartLens Pro - ä¼ä¸šçº§ </title>
    <!-- å¼•å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ QuaggaJS æ ¸å¿ƒåº“ -->
    <script src="https://unpkg.com/@ericblade/quagga2@1.8.4/dist/quagga.min.js"></script>
    <!-- å¼•å…¥ PDF.js ç”¨äºè§£æ PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <!-- å¼•å…¥ Supabase å®¢æˆ·ç«¯åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        :root { font-family: 'Inter', sans-serif; }
        
        /* ç‚¹é˜µèƒŒæ™¯å›¾æ¡ˆ */
        .bg-dot-pattern {
            background-image: radial-gradient(#e5e7eb 1.5px, transparent 1.5px);
            background-size: 20px 20px;
        }

        #canvasHidden { display: none; } 
        
        /* é¢„è§ˆå®¹å™¨æ ·å¼è°ƒæ•´ */
        .preview-container { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        #canvasOverlay {
            position: absolute;
            top: 0;
            left: 0;
            pointer-events: none;
            width: 100%;
            height: 100%;
        }
        #previewImg {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain; 
            display: none;
            transition: opacity 0.3s ease;
        }
        
        /* ç¾åŒ–æ»šåŠ¨æ¡ */
        textarea::-webkit-scrollbar, .history-scroll::-webkit-scrollbar { width: 6px; height: 6px; }
        textarea::-webkit-scrollbar-track, .history-scroll::-webkit-scrollbar-track { background: transparent; }
        textarea::-webkit-scrollbar-thumb, .history-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        textarea::-webkit-scrollbar-thumb:hover, .history-scroll::-webkit-scrollbar-thumb { background: #94a3b8; }
        
        .animate-fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* ç™»å½•é®ç½©å±‚ */
        #loginOverlay {
            position: fixed;
            inset: 0;
            background-color: #f3f4f6;
            z-index: 100;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .no-select { user-select: none; -webkit-user-select: none; }

        /* Toggle Switch (APIå¼€å…³æ ·å¼) */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #10b981;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #10b981;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            50: '#eff6ff', 
                            100: '#dbeafe', 
                            500: '#3b82f6', 
                            600: '#2563eb', 
                            700: '#1d4ed8'
                        }
                    }
                }
            }
        }
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
</head>
<body class="bg-[#f3f4f6] text-slate-800 min-h-screen flex flex-col antialiased selection:bg-brand-500/30">

    <!-- 0. ç™»å½•é®ç½©å±‚ -->
    <div id="loginOverlay">
        <div class="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full border border-slate-200 text-center">
            <div class="w-12 h-12 bg-brand-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand-500/20 mx-auto mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path></svg>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">SmartLens Pro</h2>
            <p class="text-sm text-slate-400 mb-6">ä¼ä¸šçº§æ¡ç å¤„ç†å·¥ä½œå°</p>
            
            <div class="space-y-4 text-left">
                <!-- è´¦å· -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">è´¦å·</label>
                    <input type="text" id="loginUser" onkeydown="handleEnter(event)" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-brand-500 transition">
                </div>
                <!-- å¯†ç  (å¸¦çœ¼ç›) -->
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-1">å¯†ç </label>
                    <div class="relative">
                        <input type="password" id="loginPass" onkeydown="handleEnter(event)" class="w-full bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 text-sm outline-none focus:border-brand-500 transition pr-10">
                        <!-- çœ¼ç›æŒ‰é’®ï¼šé•¿æŒ‰æ˜¾ç¤º -->
                        <button id="eyeBtn" type="button" class="absolute right-0 top-0 bottom-0 px-3 text-slate-400 hover:text-slate-600 flex items-center cursor-pointer no-select" title="é•¿æŒ‰æ˜¾ç¤ºå¯†ç ">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </button>
                    </div>
                </div>
                <button onclick="handleLogin()" id="loginBtn" class="w-full bg-slate-900 text-white py-2.5 rounded-lg font-bold hover:bg-slate-800 transition shadow-lg mt-2">
                    ç™»å½•ç³»ç»Ÿ
                </button>
                <p id="loginMsg" class="text-xs text-rose-500 text-center h-4"></p>
            </div>
        </div>
    </div>

    <!-- 1. é¡¶éƒ¨å¯¼èˆªæ  -->
    <header class="bg-white h-[72px] border-b border-slate-200 px-6 flex items-center justify-between sticky top-0 z-40 shadow-sm shrink-0">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-brand-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-brand-500/20">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path><path d="m9 12 2 2 4-4"></path></svg>
            </div>
            <div>
                <h1 class="text-xl font-bold text-slate-800 tracking-tight">SmartLens PDFæ¡ç å¤„ç†å·¥ä½œå° <span class="text-brand-600">Pro v3.3</span></h1>
                <p class="text-xs text-slate-400 font-medium">æ™ºèƒ½è¯†åˆ« Â· ç²¾å‡†æå– Â· é«˜æ•ˆè‡ªåŠ¨åŒ–</p>
            </div>
        </div>

        <div class="flex items-center gap-4">
            <!-- API å¼€å…³ -->
            <div class="flex items-center gap-2 mr-2 border-r border-slate-100 pr-4">
                <span class="text-xs font-bold text-slate-400">AI åŠŸèƒ½</span>
                <div class="relative inline-block w-10 align-middle select-none transition duration-200 ease-in">
                    <input type="checkbox" name="toggle" id="apiKeyToggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-slate-300 transition-all duration-300 left-0" onchange="toggleApiKeyUsage()"/>
                    <label for="apiKeyToggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-slate-300 cursor-pointer transition-colors duration-300"></label>
                </div>
                <!-- çŠ¶æ€èƒ¶å›Š -->
                <div id="apiStatusIndicator" class="flex items-center gap-2 px-3 py-1 bg-slate-100 text-slate-500 rounded-full text-[10px] font-bold tracking-wide transition-colors border border-transparent">
                    <span id="apiStatusDot" class="w-1.5 h-1.5 rounded-full bg-slate-400"></span>
                    <span id="apiStatusText">OFF</span>
                </div>
            </div>

            <!-- ç”¨æˆ·ä¿¡æ¯ -->
            <div class="text-right hidden md:block">
                <div id="currentUserDisplay" class="text-sm font-bold text-slate-700">æœªç™»å½•</div>
                <div id="currentRoleDisplay" class="text-[10px] text-slate-400 font-mono uppercase">GUEST</div>
            </div>

            <!-- ç®¡ç†å‘˜æŒ‰é’® -->
            <button id="adminBtn" onclick="toggleAdminPanel()" class="hidden px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-600 rounded-lg text-xs font-bold transition flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="8.5" cy="7" r="4"></circle><line x1="20" y1="8" x2="20" y2="14"></line><line x1="23" y1="11" x2="17" y2="11"></line></svg>
                è´¦å·ç®¡ç†
            </button>
            
            <button onclick="handleLogout()" class="p-2 text-rose-400 hover:text-rose-600 transition-colors rounded-full hover:bg-rose-50" title="é€€å‡ºç™»å½•">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
            </button>
        </div>
    </header>

    <!-- ä¸»å†…å®¹åŒºåŸŸ -->
    <main class="flex-1 max-w-[1920px] w-full mx-auto p-6 grid grid-cols-12 gap-6 overflow-hidden min-h-0">
        <!-- å·¦ä¾§æ  -->
        <aside class="col-span-12 lg:col-span-4 xl:col-span-3 bg-white rounded-2xl shadow-sm border border-slate-200 flex flex-col overflow-hidden h-full max-h-[calc(100vh-120px)]">
            <div class="p-6 pb-2">
                <h2 class="text-lg font-bold text-slate-800 flex items-center gap-3">
                    <span class="w-1.5 h-6 bg-brand-600 rounded-full"></span>
                    æ•°æ®æ–‡ä»¶è½½å…¥
                </h2>
            </div>
            
            <!-- æ–‡ä»¶è½½å…¥åŒºåŸŸï¼šä¸Šä¸‹åˆ†æ å¸ƒå±€ (ä¿æŒæ‚¨è¦æ±‚çš„å¸ƒå±€) -->
            <div class="flex-1 px-6 py-4 flex flex-col min-h-0">
                <div id="dropArea" class="flex-1 border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50 bg-dot-pattern relative group transition-all duration-300 hover:border-brand-400 hover:bg-brand-50/30 overflow-hidden flex flex-col p-4 gap-3">
                    
                    <!-- 1. æ–‡ä»¶åæ˜¾ç¤ºåŒºåŸŸï¼ˆé¡¶éƒ¨ï¼‰ -->
                    <div id="fileNameDisplay" class="w-full text-center bg-white shadow-sm py-2 px-3 rounded-lg text-xs font-semibold text-slate-600 truncate border border-slate-100 hidden shrink-0">
                        filename.pdf
                    </div>

                    <!-- 2. å†…å®¹å¸ƒå±€ï¼šä¸Šï¼ˆæ–‡ä»¶ä¿¡æ¯ï¼‰ä¸‹ï¼ˆé¢„è§ˆå›¾ï¼‰ -->
                    <div class="flex-1 flex flex-col gap-3 min-h-0 relative">
                        
                        <!-- A. æ–‡ä»¶/å ä½ç¬¦åŒºåŸŸ (å›ºå®šé«˜åº¦æˆ–è‡ªé€‚åº”) -->
                        <div id="placeholder" class="shrink-0 flex items-center justify-center min-h-[140px] transition-all duration-300">
                             <!-- é»˜è®¤æ‹–æ‹½æç¤ºå†…å®¹ -->
                             <div class="text-center pointer-events-none p-2">
                                <div class="mb-3 text-4xl opacity-30 mx-auto w-16 h-16 flex items-center justify-center bg-white rounded-full shadow-sm">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>
                                </div>
                                <p class="text-sm font-semibold text-slate-600 mb-1">ç‚¹å‡»ä¸Šä¼  æˆ– æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</p>
                                <p class="text-[10px] text-slate-400">æ”¯æŒ PDF / PNG / JPG</p>
                            </div>
                        </div>

                        <!-- B. é¢„è§ˆå›¾åŒºåŸŸ (å æ®å‰©ä½™ç©ºé—´) -->
                        <div class="flex-1 relative bg-white/60 rounded-xl border border-slate-200/60 flex items-center justify-center overflow-hidden min-h-[120px] shadow-sm">
                             <div id="previewEmptyText" class="text-slate-300 text-xs font-medium select-none pointer-events-none">ç­‰å¾…é¢„è§ˆ...</div>
                             <div class="preview-container w-full h-full flex items-center justify-center absolute inset-0 p-2">
                                 <img id="previewImg" class="max-w-full max-h-full object-contain rounded shadow-sm" style="display: none;">
                                 <canvas id="canvasOverlay" class="absolute inset-0 w-full h-full pointer-events-none"></canvas>
                             </div>
                        </div>

                    </div>
                </div>
                <input type="file" id="fileInput" accept="image/*,application/pdf" multiple class="hidden">
            </div>

            <div class="p-6 pt-2 space-y-3 bg-white border-t border-slate-100 z-10">
                <button id="uploadBtn" class="w-full py-2.5 rounded-lg border border-slate-200 text-slate-600 text-sm font-semibold hover:bg-slate-50 transition flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg> é€‰æ‹©æœ¬åœ°æ–‡ä»¶
                </button>
                <div class="grid grid-cols-2 gap-3">
                    <button id="startBtn" onclick="startProcessing()" disabled class="col-span-1 bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-50 disabled:cursor-not-allowed transition-all py-3 rounded-lg text-sm font-bold shadow-lg shadow-slate-200 flex items-center justify-center gap-2"><span>â–¶ï¸</span> å¼€å§‹æ·±åº¦è¯†åˆ«</button>
                    <button id="stopBtn" onclick="stopTask()" disabled class="col-span-1 bg-white border border-rose-100 text-rose-500 hover:bg-rose-50 disabled:opacity-50 disabled:cursor-not-allowed transition-all py-3 rounded-lg text-sm font-bold flex items-center justify-center">åœæ­¢</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                     <button onclick="clearAll()" class="col-span-1 w-full text-xs text-slate-400 hover:text-slate-600 flex items-center justify-center gap-1 py-2 border border-slate-100 rounded-lg hover:bg-slate-50">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path></svg> æ¸…ç©ºé‡ç½®
                    </button>
                    <button onclick="toggleHistoryModal()" class="col-span-1 w-full text-xs text-brand-500 hover:text-brand-700 flex items-center justify-center gap-1 py-2 border border-brand-100 bg-brand-50 rounded-lg hover:bg-brand-100">
                        <svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> å†å²è®°å½•
                    </button>
                </div>
            </div>
        </aside>

        <!-- å³ä¾§æ  -->
        <div class="col-span-12 lg:col-span-8 xl:col-span-9 flex flex-col gap-6 h-full min-h-0 overflow-y-auto pr-1 pb-1">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 shrink-0">
                <div class="bg-brand-600 rounded-2xl p-5 text-white shadow-lg shadow-brand-500/20 relative overflow-hidden group">
                    <div class="absolute right-0 top-0 opacity-10 transform translate-x-4 -translate-y-4 group-hover:scale-110 transition-transform duration-500"><svg width="120" height="120" viewBox="0 0 24 24" fill="currentColor"><path d="M4 7c0-1.1.9-2 2-2h2.5a.5.5 0 0 1 0 1H6a1 1 0 0 0-1 1v2.5a.5.5 0 0 1-1 0V7zm0 10v-2.5a.5.5 0 0 1 1 0V17a1 1 0 0 0 1 1h2.5a.5.5 0 0 1 0 1H6a2 2 0 0 1-2-2zm10 2.5a.5.5 0 0 1 0-1H18a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0V17a2 2 0 0 1-2 2h-4.5zM19 9.5v-2.5a1 1 0 0 0-1-1h-2.5a.5.5 0 0 1 0-1H18a2 2 0 0 1 2 2v2.5a.5.5 0 0 1-1 0z"/></svg></div>
                    <p class="text-brand-100 text-xs font-semibold uppercase tracking-wider mb-1">æ¡ç è¯†åˆ«ç»“æœ</p>
                    <div class="flex items-baseline gap-2"><span id="barcodeCountBadgeDisplay" class="text-4xl font-bold tracking-tight">0</span><span class="text-sm text-brand-200 font-medium italic">Items Detected</span></div>
                </div>
                <div class="bg-white rounded-2xl p-5 border border-slate-200 shadow-sm relative overflow-hidden">
                    <p class="text-slate-400 text-xs font-semibold uppercase tracking-wider mb-1">å¤„ç†é¡µæ•°</p>
                    <div class="flex items-baseline gap-2"><span id="pageCountDisplay" class="text-4xl font-bold text-slate-800 tracking-tight">0</span><span class="text-sm text-slate-400 font-medium italic">Pages</span></div>
                    <span id="barcodeCountBadge" class="hidden">0</span>
                </div>
            </div>
            <div id="progressSection" class="hidden bg-white border border-slate-100 px-4 py-3 rounded-xl flex items-center gap-3 shadow-sm animate-fade-in">
                <div id="progressIconContainer" class="w-6 h-6 rounded-full flex items-center justify-center text-brand-600"><svg class="animate-spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg></div>
                <div class="flex-1 flex justify-between items-center"><span id="mainStatusText" class="text-sm font-semibold text-slate-700">å‡†å¤‡å°±ç»ª</span><span id="subStatusText" class="text-xs text-slate-400">ç­‰å¾…æ“ä½œ</span></div>
                <div id="pageBadge" class="text-xs font-mono bg-slate-100 px-2 py-0.5 rounded text-slate-600 hidden">0/0</div>
            </div>
            <div class="flex-1 grid grid-cols-1 lg:grid-cols-2 gap-6 min-h-0">
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col overflow-hidden h-full">
                    <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0">
                        <h3 class="font-bold text-brand-600 text-sm flex items-center gap-2">æ¡ç æ˜ç»† - æå–åŒº <span class="text-[10px] text-brand-600 font-bold px-2 py-0.5 bg-brand-50 rounded-full border border-brand-100">å…± <span id="barcodeDetailCount">0</span> æ¡</span></h3>
                        <button onclick="copyResults('resultArea')" class="text-slate-400 hover:text-brand-600 transition p-1" title="å¤åˆ¶"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>
                    </div>
                    <textarea id="resultArea" placeholder="è¯†åˆ«å‡ºçš„æ¡ç æ•°å€¼..." class="flex-1 w-full p-5 resize-none outline-none text-sm font-mono text-slate-600 leading-relaxed placeholder-slate-300 bg-transparent"></textarea>
                </div>
                <div class="bg-white rounded-2xl border border-slate-200 shadow-sm flex flex-col overflow-hidden h-full">
                    <div class="px-5 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0">
                        <h3 class="font-bold text-slate-500 text-sm flex items-center gap-2">æ–‡æœ¬æå–ä¿¡æ¯ (OCR)</h3>
                        <div class="flex items-center gap-2"><span class="text-[10px] bg-slate-50 text-slate-400 px-2 py-0.5 rounded-full border border-slate-100">ä»…å¥‡æ•°é¡µ</span><button onclick="copyResults('ocrResultArea')" class="text-slate-400 hover:text-brand-600 transition p-1" title="å¤åˆ¶"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button></div>
                    </div>
                    <textarea id="ocrResultArea" placeholder="AI æå–çš„ç‰¹å¾æ–‡æœ¬..." class="flex-1 w-full p-5 resize-none outline-none text-sm font-mono text-slate-600 leading-relaxed placeholder-slate-300 bg-transparent"></textarea>
                </div>
            </div>
        </div>
    </main>
    
    <canvas id="canvasHidden"></canvas>

    <!-- æ¶ˆæ¯æ¡† -->
    <div id="messageBox" class="fixed inset-0 bg-slate-900/40 backdrop-blur-[2px] hidden items-center justify-center z-[200] animate-fade-in">
        <div class="bg-white p-6 rounded-2xl shadow-2xl border border-slate-100 max-w-sm w-full transform transition-all scale-100">
            <h3 id="messageTitle" class="text-lg font-bold mb-2 text-slate-800 flex items-center gap-2">æç¤º</h3>
            <p id="messageContent" class="text-slate-500 mb-6 text-sm leading-relaxed"></p>
            <button onclick="closeMessageBox()" class="w-full bg-brand-600 text-white py-2.5 rounded-xl font-medium hover:bg-brand-700 transition duration-150 shadow-lg shadow-brand-500/20">ç¡®å®š</button>
        </div>
    </div>

    <!-- å†å²è®°å½•é¢æ¿ (æ–°å¢) -->
    <div id="historyModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-[2px] hidden items-center justify-center z-[160] animate-fade-in">
        <div class="bg-white p-6 rounded-2xl shadow-2xl border border-slate-100 max-w-lg w-full max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-4 shrink-0">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">ğŸ“œ å†å²æ•°æ®è®°å½• (æœ€è¿‘10æ¬¡)</h3>
                <button onclick="toggleHistoryModal()" class="text-slate-400 hover:text-slate-600"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"></path></svg></button>
            </div>
            <div id="historyListContainer" class="overflow-y-auto pr-2 space-y-3 flex-1 history-scroll">
                <!-- å†å²æ¡ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                <div class="text-center text-slate-400 py-10 text-sm">æš‚æ— å†å²è®°å½•</div>
            </div>
            <div class="pt-4 border-t border-slate-100 mt-4 text-xs text-center text-slate-400">
                ç‚¹å‡»â€œæ¢å¤â€å°†è¦†ç›–å½“å‰é¡µé¢çš„æå–ç»“æœ
            </div>
        </div>
    </div>

    <!-- ç®¡ç†å‘˜é¢æ¿ -->
    <div id="adminModal" class="fixed inset-0 bg-slate-900/40 backdrop-blur-[2px] hidden items-center justify-center z-[150] animate-fade-in">
        <div class="bg-white p-8 rounded-2xl shadow-2xl border border-slate-100 max-w-2xl w-full max-h-[80vh] flex flex-col">
            <div class="flex justify-between items-center mb-6 shrink-0">
                <h3 class="text-xl font-bold text-slate-800 flex items-center gap-2">ğŸ›¡ï¸ ç³»ç»Ÿç®¡ç†æ§åˆ¶å°</h3>
                <button onclick="toggleAdminPanel()" class="text-slate-400 hover:text-slate-600"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"></path></svg></button>
            </div>
            <div class="overflow-y-auto pr-2 space-y-6">
                <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                    <h4 class="text-sm font-bold text-slate-700 mb-3">å…¨å±€ API Key é…ç½®</h4>
                    <div class="relative">
                        <input type="password" id="globalApiKeyInput" placeholder="sk-..." class="w-full bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm pr-10">
                        <button id="adminEyeBtn" onclick="toggleAdminKeyVisibility()" class="absolute right-20 top-0 bottom-0 px-2 text-slate-400 hover:text-slate-600 flex items-center" title="æ˜¾ç¤º/éšè— Key">
                            <svg id="adminEyeIcon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"></path><circle cx="12" cy="12" r="3"></circle></svg>
                        </button>
                        <button onclick="saveGlobalApiKey()" class="absolute right-1 top-1 bottom-1 bg-brand-600 text-white px-3 rounded text-xs font-bold hover:bg-brand-700">ä¿å­˜æ›´æ–°</button>
                    </div>
                    <p class="text-[10px] text-slate-400 mt-2">æ­¤ Key å°†è‡ªåŠ¨åˆ†å‘ç»™æ‰€æœ‰å‘˜å·¥è´¦å·ï¼Œå‘˜å·¥æ— éœ€æ‰‹åŠ¨è¾“å…¥ã€‚</p>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-slate-700 mb-3 flex justify-between items-center">ç”¨æˆ·åˆ—è¡¨ <span class="text-xs font-normal text-slate-400" id="userCount">loading...</span></h4>
                    <div class="grid grid-cols-12 gap-2 mb-4">
                        <input type="text" id="newUserName" placeholder="æ–°è´¦å·" class="col-span-3 bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm">
                        <input type="text" id="newUserPass" placeholder="å¯†ç " class="col-span-3 bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm">
                        <input type="text" id="newUserRemark" placeholder="å¤‡æ³¨(å¦‚:å¼ ä¸‰)" class="col-span-4 bg-white border border-slate-200 rounded-lg px-3 py-2 text-sm">
                        <button onclick="addUser()" class="col-span-2 bg-emerald-500 text-white rounded-lg text-sm font-bold hover:bg-emerald-600 flex items-center justify-center gap-1"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg> æ·»åŠ </button>
                    </div>
                    <div class="border border-slate-200 rounded-xl overflow-hidden">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-semibold"><tr><th class="px-4 py-3">è´¦å·</th><th class="px-4 py-3">å¤‡æ³¨</th><th class="px-4 py-3">è§’è‰²</th><th class="px-4 py-3 text-right">æ“ä½œ</th></tr></thead>
                            <tbody id="userListBody" class="divide-y divide-slate-100 bg-white"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

<script>
    // ==========================================
    // 1. Supabase é…ç½®
    // ==========================================
    const YOUR_SUPABASE_URL = 'https://qzvnxshmanuiqeljxywm.supabase.co';
    const YOUR_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF6dm54c2htYW51aXFlbGp4eXdtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYwNzYzNDIsImV4cCI6MjA4MTY1MjM0Mn0.wpVInI3YQrgo51BraYYdvcEkQWZk-TR3D3VD6QKxa2s';
    
    const { createClient } = supabase;
    const db = createClient(YOUR_SUPABASE_URL, YOUR_SUPABASE_KEY);

    // ==========================================
    // 2. å…¨å±€å˜é‡ä¸ UI å¼•ç”¨
    // ==========================================
    let currentUser = null;
    let QWEN_API_KEY = "";
    let isApiKeyEnabled = false; 
    const SESSION_KEY = "sxz_session_v1";
    const HISTORY_KEY = "sxz_history_log_v1"; // å†å²è®°å½• Key
    let fileQueue = [];
    let shouldStop = false; 

    // UI å…ƒç´ å¼•ç”¨
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn'); 
    const startBtn = document.getElementById('startBtn'); 
    const stopBtn = document.getElementById('stopBtn');
    const previewImg = document.getElementById('previewImg');
    const resultArea = document.getElementById('resultArea');
    const ocrResultArea = document.getElementById('ocrResultArea'); 
    const dropArea = document.getElementById('dropArea');
    const placeholder = document.getElementById('placeholder');
    const fileNameDisplay = document.getElementById('fileNameDisplay');
    const previewEmptyText = document.getElementById('previewEmptyText');
    
    // è¿›åº¦æ¡ä¸çŠ¶æ€æ˜¾ç¤ºå¼•ç”¨
    const progressSection = document.getElementById('progressSection');
    const progressIconContainer = document.getElementById('progressIconContainer');
    const mainStatusText = document.getElementById('mainStatusText');
    const subStatusText = document.getElementById('subStatusText');
    const pageBadge = document.getElementById('pageBadge');
    
    // Canvas & å¼¹çª—å¼•ç”¨
    const canvasHidden = document.getElementById('canvasHidden');
    const ctxHidden = canvasHidden.getContext('2d', { willReadFrequently: true });
    const messageBox = document.getElementById('messageBox');
    const messageTitle = document.getElementById('messageTitle');
    const messageContent = document.getElementById('messageContent');

    // ==========================================
    // 3. åˆå§‹åŒ–é€»è¾‘
    // ==========================================
    window.addEventListener('DOMContentLoaded', async () => {
        initEyeIconEvents();
        bindEventListeners(); 

        const savedSession = localStorage.getItem(SESSION_KEY);
        if (savedSession) {
            try {
                const user = JSON.parse(savedSession);
                await restoreSession(user);
            } catch (e) {
                console.warn("Session restore failed:", e);
                localStorage.removeItem(SESSION_KEY);
            }
        }
        updateApiStatusUI();
    });

    // ==========================================
    // 4. äº‹ä»¶ç»‘å®šé€»è¾‘
    // ==========================================
    function bindEventListeners() {
        if(uploadBtn) uploadBtn.addEventListener('click', () => fileInput.click());
        
        if(fileInput) {
            fileInput.addEventListener('change', e => { 
                if(e.target.files && e.target.files.length > 0) handleFilesSelect(e.target.files); 
                fileInput.value = ''; 
            });
        }

        document.addEventListener('paste', e => {
            const items = e.clipboardData.items; 
            const files = [];
            for (let item of items) { 
                if (item.type.indexOf('image') !== -1) { files.push(item.getAsFile()); } 
            }
            if (files.length > 0) { handleFilesSelect(files); e.preventDefault(); }
        });

        if(dropArea) {
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropArea.addEventListener(eventName, e => { 
                    e.preventDefault(); 
                    e.stopPropagation(); 
                    if (eventName === 'dragenter' || eventName === 'dragover') {
                        dropArea.classList.add('border-brand-400', 'bg-brand-50');
                    } else {
                        dropArea.classList.remove('border-brand-400', 'bg-brand-50');
                    }
                }, false);
            });
            
            dropArea.addEventListener('drop', e => { 
                const dt = e.dataTransfer; 
                const files = dt.files; 
                if (files.length > 0) handleFilesSelect(files); 
            }, false);
        }
    }

    // ==========================================
    // 5. ç”¨æˆ·ä¸æƒé™é€»è¾‘
    // ==========================================
    async function handleLogin() {
        const username = document.getElementById('loginUser').value.trim();
        const password = document.getElementById('loginPass').value.trim();
        const msg = document.getElementById('loginMsg');
        const btn = document.getElementById('loginBtn');

        if(!username || !password) { msg.innerText = "è¯·è¾“å…¥è´¦å·å’Œå¯†ç "; return; }

        btn.disabled = true; btn.innerText = "éªŒè¯ä¸­..."; msg.innerText = "";

        try {
            const { data, error } = await db.from('app_users').select('*').eq('username', username).eq('password', password).single();
            
            if (error || !data) throw new Error("è´¦å·æˆ–å¯†ç é”™è¯¯");
            if (data.is_active === false) throw new Error("è¯¥è´¦å·å·²è¢«åœç”¨ï¼Œè¯·è”ç³»ç®¡ç†å‘˜");

            localStorage.setItem(SESSION_KEY, JSON.stringify(data));
            await restoreSession(data);
        } catch (err) {
            msg.innerText = err.message;
            btn.disabled = false;
            btn.innerText = "ç™»å½•ç³»ç»Ÿ";
        }
    }

    async function restoreSession(user) {
        currentUser = user;
        const isAdmin = (user.role === 'SXZadmin');
        document.getElementById('loginOverlay').style.display = 'none';
        document.getElementById('currentUserDisplay').innerText = user.remark || user.username;
        document.getElementById('currentRoleDisplay').innerText = isAdmin ? "ADMINISTRATOR" : "STAFF";
        if(isAdmin) {
            document.getElementById('adminBtn').classList.remove('hidden');
            setTimeout(loadUserList, 100); 
        }
        await fetchGlobalApiKey();
    }

    function handleLogout() {
        currentUser = null;
        QWEN_API_KEY = "";
        isApiKeyEnabled = false;
        localStorage.removeItem(SESSION_KEY);
        location.reload(); 
    }

    // ==========================================
    // 6. æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ (æ–‡ä»¶å¤„ç†ã€è¯†åˆ«)
    // ==========================================

    function handleFilesSelect(files) {
        if (!files || files.length === 0) return;
        const validFiles = Array.from(files).filter(file => file.type === 'application/pdf' || file.type.startsWith('image/'));
        if (validFiles.length === 0) { showMessageBox("æ ¼å¼é”™è¯¯", "ä¸æ”¯æŒçš„æ ¼å¼", "error"); return; }

        fileQueue = validFiles;
        shouldStop = false;
        
        // UI æ›´æ–°
        document.getElementById('fileNameDisplay').classList.remove('hidden');
        const placeholder = document.getElementById('placeholder');
        const previewImg = document.getElementById('previewImg');
        const emptyText = document.getElementById('previewEmptyText');

        if (validFiles.length > 1) { 
            document.getElementById('fileNameDisplay').innerText = `å·²å°±ç»ª ${validFiles.length} ä¸ªæ–‡ä»¶`; 
            // æ‰¹é‡æ–‡ä»¶æ˜¾ç¤ºå¡ç‰‡
            placeholder.innerHTML = `<div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col items-center w-40 animate-fade-in"><div class="text-4xl mb-2">ğŸ“š</div><div class="text-xs font-bold text-slate-700">æ‰¹é‡ä»»åŠ¡</div><div class="text-[10px] text-slate-400">å…± ${validFiles.length} ä¸ªæ–‡ä»¶</div></div>`;
            // é‡ç½®é¢„è§ˆåŒº
            previewImg.style.display = 'none';
            if(emptyText) emptyText.style.display = 'block';
        } else { 
            const file = validFiles[0]; 
            document.getElementById('fileNameDisplay').innerText = file.name; 
            
            if (file.type === 'application/pdf') { 
                placeholder.innerHTML = `<div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col items-center w-32 animate-fade-in"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-slate-700 mb-2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg><div class="text-xs font-bold text-slate-700">PDF æ–‡æ¡£</div><div class="text-[10px] text-slate-400 truncate w-full text-center mt-0.5" title="${file.name}">${file.name}</div></div>`;
                previewImg.style.display = 'none';
                if(emptyText) emptyText.style.display = 'block';
            } else { 
                placeholder.innerHTML = `<div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 flex flex-col items-center w-32 animate-fade-in"><svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="text-brand-600 mb-2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg><div class="text-xs font-bold text-slate-700">å›¾ç‰‡æ–‡ä»¶</div><div class="text-[10px] text-slate-400 truncate w-full text-center mt-0.5">${file.name}</div></div>`;
                const reader = new FileReader(); 
                reader.onload = e => { 
                    previewImg.src = e.target.result; 
                    previewImg.style.display = 'block'; 
                    if(emptyText) emptyText.style.display = 'none';
                }; 
                reader.readAsDataURL(file); 
            } 
        }

        resultArea.value = ''; ocrResultArea.value = ''; updateBarcodeCount(); document.getElementById('pageCountDisplay').innerText = "0"; 
        const canvasOverlay = document.getElementById('canvasOverlay');
        const ctxOverlay = canvasOverlay.getContext('2d');
        ctxOverlay.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
        
        updateProgress("æ–‡ä»¶å°±ç»ª", `ç­‰å¾…å¤„ç† ${validFiles.length} ä¸ªæ–‡ä»¶`, null, 'idle');
        startBtn.disabled = false; stopBtn.disabled = true; startBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    }

    async function startProcessing() {
        if (!fileQueue || fileQueue.length === 0) return;
        
        if (isApiKeyEnabled && !QWEN_API_KEY) {
            alert("ç³»ç»Ÿå°šæœªé…ç½® API Keyï¼Œè¯·è”ç³»ç®¡ç†å‘˜ã€‚");
            return;
        }

        startBtn.disabled = true; stopBtn.disabled = false; startBtn.innerHTML = "â³ å¤„ç†ä¸­..."; startBtn.classList.add('opacity-70', 'cursor-wait'); shouldStop = false;
        resultArea.value = ''; ocrResultArea.value = ''; updateBarcodeCount(); 
        
        for (let i = 0; i < fileQueue.length; i++) {
            if (shouldStop) break;
            const currentFile = fileQueue[i]; 
            document.getElementById('fileNameDisplay').innerText = `æ­£åœ¨å¤„ç† (${i+1}/${fileQueue.length}): ${currentFile.name}`; 
            updateProgress(`æ­£åœ¨å¤„ç†æ–‡ä»¶ ${i+1}/${fileQueue.length}`, currentFile.name, null, 'loading'); 
            appendFileHeader(currentFile.name);
            
            try {
                if (currentFile.type === 'application/pdf') await processPdfFile(currentFile);
                else await new Promise((resolve, reject) => { 
                    const reader = new FileReader(); 
                    reader.onload = async (e) => { 
                        try { await Promise.race([ processImage(e.target.result), new Promise(r => setTimeout(r, 20000)) ]); resolve(); } 
                        catch (err) { reject(err); } 
                    }; 
                    reader.onerror = reject; 
                    reader.readAsDataURL(currentFile); 
                });
            } catch (err) { console.error(`Error processing file ${currentFile.name}:`, err); }
        }
        
        if (shouldStop) {
            updateProgress("å·²åœæ­¢", "ç”¨æˆ·ç»ˆæ­¢æ“ä½œ", null, 'stopped'); 
        } else { 
            updateProgress("å…¨éƒ¨å®Œæˆ", `å·²å¤„ç† ${fileQueue.length} ä¸ªæ–‡ä»¶`, null, 'success'); 
            document.getElementById('fileNameDisplay').innerText = `å¤„ç†å®Œæˆ: å…± ${fileQueue.length} ä¸ªæ–‡ä»¶`; 
            // è‡ªåŠ¨ä¿å­˜å†å²è®°å½•
            saveHistory(fileQueue.length + "ä¸ªæ–‡ä»¶", resultArea.value, ocrResultArea.value);
        }
        
        startBtn.disabled = false; stopBtn.disabled = true; startBtn.innerHTML = "<span>â–¶ï¸</span> å¼€å§‹æ·±åº¦è¯†åˆ«"; startBtn.classList.remove('opacity-70', 'cursor-wait'); shouldStop = false;
    }

    // ==========================================
    // 7. ç®¡ç†å‘˜ä¸ç³»ç»Ÿé€»è¾‘ (å«ä¿®æ”¹å¯†ç )
    // ==========================================

    async function loadUserList() {
        const tbody = document.getElementById('userListBody');
        const countSpan = document.getElementById('userCount');
        if(!tbody) return; 
        tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-slate-400">åŠ è½½ä¸­...</td></tr>';
        
        const { data, error } = await db.from('app_users').select('*').order('username', { ascending: true });
        
        if (error) { 
            tbody.innerHTML = `<tr><td colspan="4" class="p-4 text-center text-rose-500">åŠ è½½å¤±è´¥: ${error.message}</td></tr>`; 
            return; 
        }
        countSpan.innerText = `å…± ${data.length} äºº`;
        tbody.innerHTML = '';
        data.forEach(user => {
            const isUserAdmin = (user.role === 'SXZadmin');
            const tr = document.createElement('tr');
            // æ–°å¢â€œä¿®æ”¹å¯†ç â€æŒ‰é’®
            const actionButtons = !isUserAdmin ? 
                `<div class="flex items-center justify-end gap-2">
                    <button onclick="changeUserPassword('${user.username}')" class="text-brand-500 hover:text-brand-700 text-xs font-bold px-2 py-1 rounded hover:bg-brand-50 transition">ä¿®æ”¹å¯†ç </button>
                    <button onclick="deleteUser('${user.username}')" class="text-rose-500 hover:text-rose-700 text-xs font-bold px-2 py-1 rounded hover:bg-rose-50 transition">åˆ é™¤</button>
                 </div>` : 
                '<span class="text-slate-300 text-xs">ç³»ç»Ÿç®¡ç†å‘˜</span>';
                
            tr.innerHTML = `<td class="px-4 py-3 font-medium text-slate-700">${user.username}</td><td class="px-4 py-3 text-slate-500">${user.remark || '-'}</td><td class="px-4 py-3 text-xs"><span class="${isUserAdmin ? 'bg-purple-100 text-purple-600' : 'bg-slate-100 text-slate-500'} px-2 py-0.5 rounded-full font-bold">${isUserAdmin ? 'ç®¡ç†å‘˜' : 'å‘˜å·¥'}</span></td><td class="px-4 py-3 text-right">${actionButtons}</td>`;
            tbody.appendChild(tr);
        });
    }

    async function changeUserPassword(username) {
        const newPass = prompt(`è¯·è¾“å…¥ç”¨æˆ· [${username}] çš„æ–°å¯†ç :`);
        if (newPass === null) return; // ç”¨æˆ·å–æ¶ˆ
        if (newPass.trim() === "") { alert("å¯†ç ä¸èƒ½ä¸ºç©º"); return; }
        
        const { error } = await db.from('app_users').update({ password: newPass.trim() }).eq('username', username);
        if (error) {
            alert("ä¿®æ”¹å¤±è´¥: " + error.message);
        } else {
            alert("å¯†ç ä¿®æ”¹æˆåŠŸï¼");
        }
    }

    async function deleteUser(username) {
        if (confirm(`ç¡®å®šè¦åˆ é™¤è´¦å· [${username}] å—ï¼Ÿ`)) {
            const { error } = await db.from('app_users').delete().eq('username', username);
            if (error) alert("åˆ é™¤å¤±è´¥: " + error.message);
            else loadUserList();
        }
    }

    async function addUser() {
        const u = document.getElementById('newUserName').value.trim();
        const p = document.getElementById('newUserPass').value.trim();
        const r = document.getElementById('newUserRemark').value.trim();
        if (!u || !p) { alert("è´¦å·å’Œå¯†ç å¿…å¡«"); return; }
        const { error } = await db.from('app_users').insert({ username: u, password: p, remark: r, role: 'staff', is_active: true });
        if (error) alert("æ·»åŠ å¤±è´¥: " + error.message);
        else { document.getElementById('newUserName').value = ''; document.getElementById('newUserPass').value = ''; document.getElementById('newUserRemark').value = ''; loadUserList(); }
    }

    async function saveGlobalApiKey() {
        const newKey = document.getElementById('globalApiKeyInput').value.trim();
        const { error } = await db.from('app_config').upsert({ key_name: 'qwen_api_key', key_value: newKey }, { onConflict: 'key_name' });
        if (error) alert("ä¿å­˜å¤±è´¥: " + error.message);
        else { QWEN_API_KEY = newKey; alert("API Key å·²æ›´æ–°ï¼Œå³åˆ»ç”Ÿæ•ˆã€‚"); }
    }

    async function fetchGlobalApiKey() {
        try {
            const { data, error } = await db.from('app_config').select('key_value').eq('key_name', 'qwen_api_key').single();
            if (data && data.key_value) {
                QWEN_API_KEY = data.key_value;
                if(currentUser && currentUser.role === 'SXZadmin') {
                    document.getElementById('globalApiKeyInput').value = data.key_value;
                }
            }
        } catch (e) { console.warn("No API Key config found."); }
    }

    // ==========================================
    // 8. å†å²è®°å½•é€»è¾‘ (æ–°å¢)
    // ==========================================

    function toggleHistoryModal() {
        const modal = document.getElementById('historyModal');
        if (modal.classList.contains('hidden')) { 
            renderHistoryList();
            modal.classList.remove('hidden'); modal.classList.add('flex'); 
        } else { 
            modal.classList.remove('flex'); modal.classList.add('hidden'); 
        }
    }

    function saveHistory(title, barcodeData, ocrData) {
        // å¦‚æœä¸¤ä¸ªæ¡†éƒ½ä¸ºç©ºï¼Œä¸ä¿å­˜
        if (!barcodeData.trim() && !ocrData.trim()) return;

        let history = [];
        try {
            history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        } catch (e) { history = []; }

        const newRecord = {
            id: Date.now(),
            time: new Date().toLocaleString(),
            title: title || "æœªçŸ¥æ–‡ä»¶",
            barcode: barcodeData,
            ocr: ocrData
        };

        // æ’å…¥æœ€å‰é¢
        history.unshift(newRecord);
        // åªä¿ç•™æœ€è¿‘10æ¡
        if (history.length > 10) history = history.slice(0, 10);
        
        localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
    }

    function renderHistoryList() {
        const container = document.getElementById('historyListContainer');
        let history = [];
        try {
            history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        } catch (e) { history = []; }

        if (history.length === 0) {
            container.innerHTML = '<div class="text-center text-slate-400 py-10 text-sm">æš‚æ— å†å²è®°å½•</div>';
            return;
        }

        container.innerHTML = '';
        history.forEach(item => {
            const div = document.createElement('div');
            div.className = "bg-slate-50 hover:bg-white border border-slate-100 hover:border-brand-200 p-3 rounded-xl transition cursor-pointer group";
            div.innerHTML = `
                <div class="flex justify-between items-start mb-1">
                    <span class="text-xs font-bold text-slate-600">${item.time}</span>
                    <button onclick="restoreHistoryItem(${item.id})" class="text-[10px] bg-white border border-slate-200 text-slate-500 px-2 py-0.5 rounded hover:bg-brand-500 hover:text-white transition">æ¢å¤</button>
                </div>
                <div class="text-xs text-slate-400 mb-2 truncate">${item.title}</div>
                <div class="flex gap-2">
                    <span class="text-[10px] bg-slate-200 text-slate-600 px-1.5 rounded">æ¡ç : ${item.barcode.length > 20 ? 'æœ‰æ•°æ®' : 'ç©º'}</span>
                    <span class="text-[10px] bg-slate-200 text-slate-600 px-1.5 rounded">OCR: ${item.ocr.length > 20 ? 'æœ‰æ•°æ®' : 'ç©º'}</span>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function restoreHistoryItem(id) {
        let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || "[]");
        const item = history.find(i => i.id === id);
        if (item) {
            if(confirm('æ¢å¤å†å²è®°å½•å°†è¦†ç›–å½“å‰é¡µé¢ä¸Šçš„æ‰€æœ‰æå–ç»“æœï¼Œç¡®å®šå—ï¼Ÿ')) {
                resultArea.value = item.barcode;
                ocrResultArea.value = item.ocr;
                updateBarcodeCount();
                toggleHistoryModal(); // å…³é—­å¼¹çª—
                showMessageBox("æ¢å¤æˆåŠŸ", "å†å²æ•°æ®å·²åŠ è½½åˆ°ç¼–è¾‘æ¡†", "success");
            }
        }
    }

    // ==========================================
    // 9. è¾…åŠ©å‡½æ•° (UI & å·¥å…·)
    // ==========================================
    
    function toggleApiKeyUsage() {
        const toggle = document.getElementById('apiKeyToggle');
        isApiKeyEnabled = toggle.checked;
        updateApiStatusUI();
    }

    function updateApiStatusUI() {
        const indicator = document.getElementById('apiStatusIndicator');
        const dot = document.getElementById('apiStatusDot');
        const text = document.getElementById('apiStatusText');
        const toggle = document.getElementById('apiKeyToggle');
        toggle.checked = isApiKeyEnabled;
        if (isApiKeyEnabled) {
            indicator.className = "flex items-center gap-2 px-4 py-1.5 bg-emerald-50 text-emerald-600 rounded-full text-xs font-bold tracking-wide transition-colors border border-emerald-100";
            dot.className = "w-2 h-2 rounded-full bg-emerald-500 animate-pulse";
            text.innerText = "AI ON";
        } else {
            indicator.className = "flex items-center gap-2 px-4 py-1.5 bg-slate-100 text-slate-500 rounded-full text-xs font-bold tracking-wide transition-colors border border-transparent";
            dot.className = "w-2 h-2 rounded-full bg-slate-400";
            text.innerText = "OFF";
        }
    }

    function toggleAdminPanel() {
        const modal = document.getElementById('adminModal');
        if (modal.classList.contains('hidden')) { modal.classList.remove('hidden'); modal.classList.add('flex'); loadUserList(); } 
        else { modal.classList.remove('flex'); modal.classList.add('hidden'); }
    }

    function toggleAdminKeyVisibility() {
        const input = document.getElementById('globalApiKeyInput');
        input.type = input.type === 'password' ? 'text' : 'password';
    }

    function initEyeIconEvents() {
        const eyeBtn = document.getElementById('eyeBtn');
        const passInput = document.getElementById('loginPass');
        const showPass = () => passInput.type = 'text';
        const hidePass = () => passInput.type = 'password';
        if(eyeBtn) {
            eyeBtn.addEventListener('mousedown', showPass);
            eyeBtn.addEventListener('mouseup', hidePass);
            eyeBtn.addEventListener('mouseleave', hidePass);
            eyeBtn.addEventListener('touchstart', (e) => { e.preventDefault(); showPass(); });
            eyeBtn.addEventListener('touchend', hidePass);
        }
    }

    function handleEnter(e) { if(e.key === "Enter") handleLogin(); }

    function showMessageBox(title, content, type = 'error') {
        messageTitle.innerText = title; messageContent.innerText = content;
        if(type === 'error') messageTitle.className = "text-lg font-bold mb-2 text-rose-600 flex items-center gap-2";
        else messageTitle.className = "text-lg font-bold mb-2 text-brand-600 flex items-center gap-2";
        messageBox.classList.remove('hidden'); messageBox.classList.add('flex');
    }
    function closeMessageBox() { messageBox.classList.remove('flex'); messageBox.classList.add('hidden'); }

    function updateBarcodeCount() {
        const val = resultArea.value; const lines = val.split('\n');
        const count = lines.filter(line => line.trim() !== '' && !line.trim().startsWith('ã€')).length;
        document.getElementById('barcodeCountBadge').innerText = count; 
        document.getElementById('barcodeCountBadgeDisplay').innerText = count; 
        const detailCountSpan = document.getElementById('barcodeDetailCount');
        if (detailCountSpan) detailCountSpan.innerText = count;
    }

    function updateProgress(mainText, subText = "", pageInfo = null, statusType = 'loading') {
        progressSection.classList.remove('hidden');
        mainStatusText.innerText = mainText;
        if (subText) subStatusText.innerText = subText;
        if (pageInfo) {
            pageBadge.classList.remove('hidden');
            pageBadge.innerText = `${pageInfo.current} / ${pageInfo.total}`;
        } else {
            pageBadge.classList.add('hidden');
        }
        progressIconContainer.className = "w-6 h-6 rounded-full flex items-center justify-center"; 
        let svgContent = '';
        switch(statusType) {
            case 'loading': progressIconContainer.classList.add('text-brand-600'); svgContent = `<svg class="animate-spin" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>`; break;
            case 'success': progressIconContainer.classList.add('text-emerald-500'); svgContent = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>`; break;
            case 'stopped': case 'error': progressIconContainer.classList.add('text-rose-500'); svgContent = `<svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor" stroke="none"><rect x="6" y="6" width="12" height="12" rx="1"></rect></svg>`; break;
            default: progressIconContainer.classList.add('text-slate-400'); svgContent = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>`; break;
        }
        progressIconContainer.innerHTML = svgContent;
    }

    function appendFileHeader(filename) {
        if (resultArea.value.length > 0 && !resultArea.value.endsWith('\n')) { resultArea.value += '\n'; } resultArea.value += `ã€${filename}ã€‘\n`; resultArea.scrollTop = resultArea.scrollHeight;
        if (ocrResultArea.value.length > 0 && !ocrResultArea.value.endsWith('\n')) { ocrResultArea.value += '\n'; } ocrResultArea.value += `ã€${filename}ã€‘\n`; ocrResultArea.scrollTop = ocrResultArea.scrollHeight;
    }

    function clearAll() { 
        fileQueue = []; resultArea.value = ''; ocrResultArea.value = ''; updateBarcodeCount(); document.getElementById('pageCountDisplay').innerText = "0"; 
        const previewImg = document.getElementById('previewImg');
        const placeholder = document.getElementById('placeholder');
        const emptyText = document.getElementById('previewEmptyText');
        
        previewImg.src = ''; previewImg.style.display = 'none'; 
        if(emptyText) emptyText.style.display = 'block';
        
        // é‡ç½®ä¸ºåˆå§‹æ‹–æ‹½æç¤º
        placeholder.innerHTML = `<div class="text-center pointer-events-none p-2"><div class="mb-3 text-4xl opacity-30 mx-auto w-16 h-16 flex items-center justify-center bg-white rounded-full shadow-sm"><svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg></div><p class="text-sm font-semibold text-slate-600 mb-1">ç‚¹å‡»ä¸Šä¼  æˆ– æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</p><p class="text-[10px] text-slate-400">æ”¯æŒ PDF / PNG / JPG</p></div>`; 
        
        document.getElementById('fileNameDisplay').classList.add('hidden'); 
        const canvasOverlay = document.getElementById('canvasOverlay');
        const ctxOverlay = canvasOverlay.getContext('2d');
        ctxOverlay.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height); 
        progressSection.classList.add('hidden'); 
        startBtn.disabled = true; stopBtn.disabled = true; startBtn.classList.add('opacity-50', 'cursor-not-allowed'); 
    }
    
    function copyResults(areaId) { const textarea = document.getElementById(areaId); if (textarea && textarea.value) { textarea.select(); document.execCommand('copy'); showMessageBox("å¤åˆ¶æˆåŠŸ", "å·²å¤åˆ¶åˆ°å‰ªè´´æ¿", "success"); } else { showMessageBox("æç¤º", "æ²¡æœ‰å¯å¤åˆ¶çš„å†…å®¹", "primary"); } }

    async function fetchWithRetry(url, options, retries = 1) {
        const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), 20000); 
        const config = { ...options, signal: controller.signal };
        try {
            const response = await fetch(url, config); clearTimeout(timeoutId);
            if (!response.ok) { const errData = await response.json(); throw new Error(errData.message || `è¯·æ±‚å¤±è´¥ (${response.status})`); }
            return response;
        } catch (err) { clearTimeout(timeoutId); if (retries > 0) { await new Promise(r => setTimeout(r, 1000)); return fetchWithRetry(url, options, retries - 1); } throw err; }
    }

    async function runOCR(base64Image) {
        if (!QWEN_API_KEY) throw new Error("API Key æœªè·å–");
        const apiUrl = "https://dashscope.aliyuncs.com/compatible-mode/v1/chat/completions";
        const sysPrompt = "è¯·è¯†åˆ«å›¾ç‰‡æ–‡å­—ã€‚è¦æ±‚ï¼š1.ä¸¥æ ¼æŒ‰ä»ä¸Šåˆ°ä¸‹ã€ä»å·¦åˆ°å³çš„è§†è§‰é¡ºåºã€‚2.ä¸éœ€è¦è¯†åˆ«ä¸”è¾“å‡ºå¸¦æœ‰â€œå‰åå°ºç ä¸åŒï¼Œè¯·ä¸è¦è´´é”™â€å’Œå›¾ç‰‡å·¦è¾¹çš„æ–‡å­—å†…å®¹ã€‚3.è€Œä¸”åªè¦è¯†åˆ«å›¾ç‰‡å³ä¸‹æ–¹æ–‡å­—å†…å®¹ã€‚ç›´æ¥è¾“å‡ºå†…å®¹ï¼Œæ— æè¿°ã€‚";
        const payload = { model: "qwen-vl-max", messages: [{ role: "user", content: [{ type: "text", text: sysPrompt }, { type: "image_url", image_url: { url: `data:image/jpeg;base64,${base64Image}` } }] }], max_tokens: 2000 };
        try {
            const response = await fetchWithRetry(apiUrl, { method: "POST", headers: { "Authorization": `Bearer ${QWEN_API_KEY}`, "Content-Type": "application/json" }, body: JSON.stringify(payload) });
            const data = await response.json();
            if (data.choices && data.choices.length > 0) return data.choices[0].message.content.trim();
            return "";
        } catch (error) { console.error("OCR API Error:", error); throw error; }
    }

    function enhanceImage(imageData) {
        const data = imageData.data;
        for (let i = 0; i < data.length; i += 4) { const gray = 0.299 * data[i] + 0.587 * data[i + 1] + 0.114 * data[i + 2]; data[i] = data[i + 1] = data[i + 2] = gray; }
        return imageData;
    }

    function drawBoundingBox(results) {
        const canvasOverlay = document.getElementById('canvasOverlay');
        const ctxOverlay = canvasOverlay.getContext('2d');
        ctxOverlay.clearRect(0, 0, canvasOverlay.width, canvasOverlay.height);
        const validResults = results.filter(r => r && r.box); if (validResults.length === 0) return;
        const uniqueCodes = new Set();
        validResults.forEach((result, index) => {
            const code = result.codeResult.code; if (uniqueCodes.has(code)) return; uniqueCodes.add(code);
            const box = result.box; if (!box || box.length < 4) return;
            ctxOverlay.strokeStyle = index === 0 ? '#10b981' : '#f59e0b'; ctxOverlay.lineWidth = 3;
            const x = Math.floor(box[0]); const y = Math.floor(box[1]); const w = Math.floor(box[2] - box[0]); const h = Math.floor(box[3] - box[1]);
            if (w > 0 && h > 0) ctxOverlay.strokeRect(x, y, w, h);
        });
    }

    async function processImage(src, pdfInfo = null) {
        if (shouldStop) return; 
        const previewImg = document.getElementById('previewImg');
        const emptyText = document.getElementById('previewEmptyText');
        
        previewImg.src = src; 
        previewImg.style.display = 'block'; 
        if(emptyText) emptyText.style.display = 'none';

        if (pdfInfo) updateProgress(`æ­£åœ¨å¤„ç†ç¬¬ ${pdfInfo.index} é¡µ`, "è§£æå›¾åƒæ•°æ®...", { current: pdfInfo.index, total: pdfInfo.total }, 'loading');
        else updateProgress("æ­£åœ¨è¯†åˆ«", "å›¾åƒåˆ†æä¸­...", null, 'loading');
        
        await new Promise((resolve, reject) => { if (previewImg.complete) resolve(); else { previewImg.onload = resolve; previewImg.onerror = () => reject(new Error("Image Load Failed")); } });
        if (shouldStop) return; 
        const imgObj = previewImg; const MAX_WIDTH = 1600; let width = imgObj.naturalWidth; let height = imgObj.naturalHeight;
        if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; } width = Math.floor(width); height = Math.floor(height);
        if (width === 0 || height === 0) return;
        
        const canvasHidden = document.getElementById('canvasHidden');
        const ctxHidden = canvasHidden.getContext('2d', { willReadFrequently: true });
        const canvasOverlay = document.getElementById('canvasOverlay');
        canvasHidden.width = canvasOverlay.width = width; canvasHidden.height = canvasOverlay.height = height;
        ctxHidden.fillStyle = "white"; ctxHidden.fillRect(0, 0, width, height); ctxHidden.drawImage(imgObj, 0, 0, width, height);
        let fullImageData = ctxHidden.getImageData(0, 0, width, height); fullImageData = enhanceImage(fullImageData); ctxHidden.putImageData(fullImageData, 0, 0);
        
        const SEGMENT_HEIGHT = 400; const step = 250; let allResults = []; const uniqueCodesSet = new Set(); 
        const decoderConfig = { numOfWorkers: 0, inputStream: { size: width }, decoder: { readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader", "i2of5_reader", "upc_reader"], multiple: true }, locate: true, patchSize: "medium", halfSample: false };
        for (let startY = 0; startY < height; startY += step) {
            if (shouldStop) break; const segmentH = Math.min(SEGMENT_HEIGHT, height - startY); if (segmentH <= 0) break;
            const segmentCanvas = document.createElement('canvas'); segmentCanvas.width = width; segmentCanvas.height = segmentH;
            const segmentCtx = segmentCanvas.getContext('2d'); const segmentImageData = ctxHidden.getImageData(0, startY, width, segmentH);
            segmentCtx.putImageData(segmentImageData, 0, 0); decoderConfig.src = segmentCanvas.toDataURL('image/jpeg', 0.85);
            await new Promise(resolve => { const qTimer = setTimeout(resolve, 3000); try { Quagga.decodeSingle(decoderConfig, function(results) { clearTimeout(qTimer); if (results && results.length > 0) { results.forEach(r => { if(r.codeResult) { const code = r.codeResult.code; if (!uniqueCodesSet.has(code)) { uniqueCodesSet.add(code); if (r.box) { r.box[1] = (r.box[1] || 0) + startY; r.box[3] = (r.box[3] || 0) + startY; } allResults.push(r); } } }); } resolve(); }); } catch (e) { clearTimeout(qTimer); resolve(); } });
            if (startY + step >= height && startY < height) break;
        }
        drawBoundingBox(allResults);
        if (allResults.length > 0) { let currentVal = resultArea.value; if (currentVal.length > 0 && !currentVal.endsWith('\n')) { resultArea.value += '\n'; } allResults.forEach(result => { resultArea.value += `${result.codeResult.code}\n`; }); resultArea.scrollTop = resultArea.scrollHeight; updateBarcodeCount(); }
        if (shouldStop) return; 

        // OCR logic
        const isOddPage = !pdfInfo || (pdfInfo.index % 2 !== 0);
        if (isOddPage) {
            if (isApiKeyEnabled && QWEN_API_KEY) { 
                if (pdfInfo) updateProgress(`æ­£åœ¨å¤„ç†ç¬¬ ${pdfInfo.index} é¡µ`, "AI è¯­ä¹‰åˆ†æä¸­...", { current: pdfInfo.index, total: pdfInfo.total }, 'loading');
                const fullPageBase64 = canvasHidden.toDataURL('image/jpeg', 0.6).split(',')[1];
                try {
                    let ocrText = await runOCR(fullPageBase64);
                    if (shouldStop) return; 
                    ocrText = ocrText.replace(/(\r\n|\n|\r)/gm, "\n");
                    ocrText = ocrText.split('\n').filter(line => line.trim() !== '').join('\n');
                    if (ocrText.length > 0) { if (ocrResultArea.value.length > 0 && !ocrResultArea.value.endsWith('\n')) { ocrResultArea.value += '\n'; } ocrResultArea.value += ocrText; ocrResultArea.scrollTop = ocrResultArea.scrollHeight; }
                } catch (e) { console.warn("OCR Failed internally:", e); }
            }
        }
    }

    async function processPdfFile(file) {
        updateProgress("åˆå§‹åŒ– PDF", "è¯»å–æ–‡ä»¶ç»“æ„...", null, 'loading');
        try {
            const arrayBuffer = await file.arrayBuffer(); const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
            if (pdf.numPages === 0) throw new Error("PDF ä¸ºç©º");
            for (let i = 1; i <= pdf.numPages; i++) {
                if (shouldStop) break; await new Promise(resolve => setTimeout(resolve, 50)); 
                updateProgress(`æ¸²æŸ“ç¬¬ ${i} é¡µ`, "å‡†å¤‡å›¾åƒæ•°æ®...", { current: i, total: pdf.numPages }, 'loading');
                try {
                    const page = await pdf.getPage(i); const viewport = page.getViewport({ scale: 2.0 }); 
                    const canvas = document.createElement('canvas'); const context = canvas.getContext('2d');
                    canvas.height = viewport.height; canvas.width = viewport.width;
                    await page.render({ canvasContext: context, viewport: viewport }).promise;
                    const dataUrl = canvas.toDataURL('image/jpeg', 0.7); 
                    if (shouldStop) break; 
                    await Promise.race([ processImage(dataUrl, { index: i, total: pdf.numPages }), new Promise((resolve) => setTimeout(() => { if (!shouldStop) console.warn(`Page ${i} Timeout`); resolve(); }, 20000)) ]);
                    canvas.width = 1; canvas.height = 1; 
                } catch (pageError) { console.error(`Page ${i} Error:`, pageError); }
            }
        } catch (error) { console.error(error); showMessageBox("PDF é”™è¯¯", error.message, "error"); throw error; }
    }

    function stopTask() { if (!shouldStop) { shouldStop = true; updateProgress("æ­£åœ¨åœæ­¢...", "ç­‰å¾…å½“å‰æ“ä½œç»“æŸ", null, 'stopped'); stopBtn.disabled = true; } }
</script>

</body>
</html>
